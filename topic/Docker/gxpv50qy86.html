<!doctype html>
<html>
    <head>
        <!-- META Tags -->
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>Docker Buildx | 风中的木偶</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <!-- SEO -->
        <meta name="author" content="风中的木偶">
        <meta name="description" content="">
        <meta name="keywords" content="木偶笔记,个人技术博客,IT技术笔记,博客,个人网站,风中的木偶,木偶">
        <meta name="twitter:card" value="summary">
                                                                <meta property="og:title" content="风中的木偶个人博客" />
                                                                <meta property="og:type" content="article" />
                                                                <meta property="og:url" content="https://wangmaolin.net" />
                                                                                            
        <!-- CSS -->
        <link rel="stylesheet" href="../../vendor/binarytorch/larecipe/assets/css/app.css">

        
        <!-- FontAwesome -->
        <link rel="stylesheet" href="../../vendor/binarytorch/larecipe/assets/css/font-awesome.css">
                    <link rel="stylesheet" href="../../vendor/binarytorch/larecipe/assets/css/font-awesome-v4-shims.css">
        
        <!-- Dynamic Colors -->
        <style>
    :root {
        --primary: #787AF6;
        --secondary: #2b9cf2;
    }

    :not(pre)>code[class*=language-], pre[class*=language-] {
        border-top: 3px solid #787AF6;
    }
    
    .bg-gradient-primary {
        background: linear-gradient(87deg, #787AF6 0, #2b9cf2 100%) !important;
    }

    [v-cloak] > * { 
        display: none; 
    }
    
    [v-cloak]::before { 
        content: " ";
        position: absolute;
        width: 100%;
        height: 100%;
        background-color: #F2F6FA;
    }
</style>
        <!-- CSRF Token -->
        <meta name="csrf-token" content="Pahvyn05xLeGT7ZyAH8zdtrdERAneaW7crP5Dk0P">

        
    </head>
    <body>
        <div id="app" v-cloak>
            <div class="fixed pin-t pin-x z-40">
    <div class="bg-gradient-primary text-white h-1"></div>

    <nav class="flex items-center justify-between text-black bg-navbar shadow-xs h-16">
        <div class="flex items-center flex-no-shrink">
            <a href="../../index.html" class="flex items-center flex-no-shrink text-black mx-4">
                
                <p class="inline-block font-semibold mx-1 text-grey-dark">
                    风中的木偶
                </p>
            </a>

            <div class="switch">
                <input type="checkbox" name="1" id="1" v-model="sidebar" class="switch-checkbox"/>
                <label class="switch-label" for="1"></label>
            </div>
        </div>

        <div class="hidden lg:flex items-center justify-end pr-4">
            <div class="relative">
                <form action="https://wangmaolin.net/search" onsubmit="return validateForm()" class="form-search">
                    <input id="search-input" name="q" type="text" placeholder="Search" class="bg-gray-100 appearance-none border-2 border-gray-200 rounded py-2 px-4
         text-gray-800 leading-tight focus:outline-none focus:bg-white focus:border-gray-500">
                </form>
            </div>
        </div>

        <div class="block mx-4 flex items-center">
                        
            
            
            
            

            
            <larecipe-dropdown>
                <larecipe-button type="primary" class="flex">
                    Docker <i class="mx-1 fa fa-angle-down"></i>
                </larecipe-button>

                <template slot="list">
                    <ul class="list-reset" style="height: 800px;width: 200px">
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../AI/overview.html">AI</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../APP/overview.html">APP</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../CSS/overview.html">CSS</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="overview.html">Docker</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../ELK/overview.html">ELK</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Git/overview.html">Git</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Go语言/overview.html">Go语言</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Laravel/overview.html">Laravel</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Linux/overview.html">Linux</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Linux&#32;服务器配置/overview.html">Linux 服务器配置</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Mac/overview.html">Mac</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../MongoDB/overview.html">MongoDB</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Mqtt/overview.html">Mqtt</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../MySQL/overview.html">MySQL</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Nginx/overview.html">Nginx</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../PHP/overview.html">PHP</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Protobuf/overview.html">Protobuf</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Python/overview.html">Python</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../SEO/overview.html">SEO</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Vue&#32;教程/overview.html">Vue 教程</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Windows/overview.html">Windows</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../webman/overview.html">webman</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../一无所有到财富自由/overview.html">一无所有到财富自由</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../云服务/overview.html">云服务</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../产品/overview.html">产品</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../元宇宙/overview.html">元宇宙</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../前端/overview.html">前端</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../合伙的本质/overview.html">合伙的本质</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../商业/overview.html">商业</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../大数据/overview.html">大数据</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../天机38局/overview.html">天机38局</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../开源项目/overview.html">开源项目</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../微信/overview.html">微信</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../控糖革命/overview.html">控糖革命</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../搜索/overview.html">搜索</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../支付/overview.html">支付</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../智慧人生/overview.html">智慧人生</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../架构/overview.html">架构</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../游戏开发/overview.html">游戏开发</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../算法/overview.html">算法</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../缓存/overview.html">缓存</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../网络/overview.html">网络</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../自媒体/overview.html">自媒体</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../菜谱/overview.html">菜谱</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../设计模式/overview.html">设计模式</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../资源/overview.html">资源</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../软件工具/overview.html">软件工具</a>
                            </li>
                                            </ul>
                </template>
            </larecipe-dropdown>
            

                    </div>
    </nav>
</div>

            
            <div>
	<div class="sidebar" :class="[{'is-hidden': ! sidebar}]">
    <ul>
<li>
<h2>服务</h2>
<ul>
<li id="blog280"><a href="gxpv5kwv86.html#blog280">使用 docker 安装 MySql</a>
<li id="blog449"><a href="nxq9zzj9do.html#blog449">使用 docker 安装 Redis</a>
<li id="blog503"><a href="k3dyk3n9l0.html#blog503">使用 Docker 安装 LInux 容器</a>
<li id="blog504"><a href="jenydzd97d.html#blog504">使用Docker 安装 xunsearch 容器</a>
</ul>
</li>
<li>
<h2>Docker</h2>
<ul>
<li id="blog494"><a href="j3oyjzx9p5.html#blog494">Docker 简介</a>
<li id="blog495"><a href="x2ev84o9or.html#blog495">Docker 的基本概念</a>
<li id="blog496"><a href="de296qwyq7.html#blog496">Docker 镜像介绍</a>
<li id="blog497"><a href="nxq9z0jvdo.html#blog497">Dockerfile 详解</a>
<li id="blog498"><a href="62wy3g39km.html#blog498">Docker 容器介绍</a>
<li id="blog499"><a href="k3dyk3o9l0.html#blog499">Docker 仓库介绍</a>
<li id="blog500"><a href="de296qqyq7.html#blog500">Docker 数据管理</a>
<li id="blog501"><a href="nxq9z03vdo.html#blog501">Docker 中的网络功能介绍</a>
<li id="blog502"><a href="62wy3gr9km.html#blog502">Docker 高级网络配置</a>
<li id="blog505"><a href="15dve32y4x.html#blog505">Docker Swarm mode 介绍</a>
<li id="blog506"><a href="34rvgdevdj.html#blog506">Docker 安全</a>
<li id="blog507"><a href="wkl9n4myz4.html#blog507">Docker 底层实现</a>
<li id="blog508"><a href="gxpv50qy86.html#blog508">Docker Buildx</a>
<li id="blog509"><a href="n3xyqlq9mq.html#blog509">Docker Etcd</a>
<li id="blog510"><a href="4x3voxmvm1.html#blog510">Docker 常见问题总结</a>
<li id="blog511"><a href="3qk94rlyw1.html#blog511">Docker 命令</a>
<li id="blog512"><a href="x569x6k9ep.html#blog512">Dockerfile 最佳实践</a>
</ul>
</li>
</ul>
</div>

<style>
    #cnzz_stat_icon_1280630928
    {
        display: none;
    }
</style>

<script src="../../vendor/binarytorch/larecipe/assets/js/jquery.min.js"></script>
<script src="../../modules/blog/js/detail.js"></script>

<script type="text/javascript">
    $(function () {
        var cid = 'gxpv50qy86.html';
        if (!checkView(cid)) {
            $.get('https://wangmaolin.net/api/blog/addView/article/gxpv50qy86.html', function (data, status) {
                addView('gxpv50qy86.html')
            });
        }
    });
</script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?7c12b9716af39eb368cff4a19aa89393";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7125202304422722"
     crossorigin="anonymous"></script>
	
	<div class="documentation is-dark" :class="{'expanded': ! sidebar}">
		<h1>Docker Buildx</h1><ul>
<li><a href="gxpv50qy86.html#7eb633f36c49c3f091c24653efdfc8d6">Docker Buildx</a></li>
<li><a href="gxpv50qy86.html#f6cb9e4bcf7e96df72a0d3d129456390">使用 BuildKit 构建镜像</a>
<ul>
<li><a href="gxpv50qy86.html#c0d9f81cf49fbc2ef92b4f8e1e26d5ce">Dockerfile 新增指令详解</a>
<ul>
<li><a href="gxpv50qy86.html#f3fbfb080b75bcde89ea2c047ea7e0c0">RUN --mount=type=cache</a></li>
<li><a href="gxpv50qy86.html#7c7395512bd319944e8b9ff102c97f01">RUN --mount=type=bind</a></li>
<li><a href="gxpv50qy86.html#04d3bbd68315e99c72e616a83c41249b">RUN --mount=type=tmpfs</a></li>
<li><a href="gxpv50qy86.html#924cf332fdf589280cc69a1d9d1e1ea6">RUN --mount=type=secret</a></li>
<li><a href="gxpv50qy86.html#8449dab7670b82a480be1cef25c0e9d8">RUN --mount=type=ssh</a></li>
</ul></li>
<li><a href="gxpv50qy86.html#cb454b1425e9fd00ad466723de2b49dc">docker-compose build 使用 Buildkit</a></li>
<li><a href="gxpv50qy86.html#992792a653fcb3d29eb9f1e11e39f623">官方文档</a></li>
</ul></li>
<li><a href="gxpv50qy86.html#eeea5b189c3002d8e00d7e561a4d9a95">使用 Buildx 构建镜像</a>
<ul>
<li><a href="gxpv50qy86.html#ecff77a8d4263545654ce610eacf996b">使用</a></li>
<li><a href="gxpv50qy86.html#992792a653fcb3d29eb9f1e11e39f623">官方文档</a></li>
</ul></li>
<li><a href="gxpv50qy86.html#5b485ff29609aa6d9e60c6a16cc45f8d">使用 buildx 构建多种系统架构支持的 Docker 镜像</a>
<ul>
<li><a href="gxpv50qy86.html#53e6c40f5f64e01cdfa89d8bc38f0806">新建 builder 实例</a></li>
<li><a href="gxpv50qy86.html#0cd7fc52e88767f46089b6fc4bc14cdc">构建镜像</a></li>
<li><a href="gxpv50qy86.html#be575b982a98e2243746ab5ac55d5166">架构相关变量</a>
<ul>
<li><a href="gxpv50qy86.html#017d5afb1e96722f97e5ae0f3af05bb7">使用举例</a></li>
</ul></li>
</ul></li>
</ul><h2 id="7eb633f36c49c3f091c24653efdfc8d6">Docker Buildx</h2>
<p>Docker Buildx 是一个 docker CLI 插件，其扩展了 docker 命令，支持 <a href="https://wangmaolin.net/topic/Docker/buildkit.md">Moby BuildKit</a> 提供的功能。提供了与 docker build 相同的用户体验，并增加了许多新功能。</p>
<blockquote>
<p>该功能仅适用于 Docker v19.03+ 版本</p>
</blockquote>
<h2 id="f6cb9e4bcf7e96df72a0d3d129456390">使用 <code>BuildKit</code> 构建镜像</h2>
<p><strong>BuildKit</strong> 是下一代的镜像构建组件，在 <a href="https://github.com/moby/buildkit">https://github.com/moby/buildkit</a> 开源。</p>
<p><strong>注意：如果您的镜像构建使用的是云服务商提供的镜像构建服务（腾讯云容器服务、阿里云容器服务等），由于上述服务提供商的 Docker 版本低于 18.09，BuildKit 无法使用，将造成镜像构建失败。建议使用 BuildKit 构建镜像时使用一个新的 Dockerfile 文件（例如 Dockerfile.buildkit）</strong></p>
<p>目前，Docker Hub 自动构建已经支持 buildkit，具体请参考 <a href="https://github.com/docker-practice/docker-hub-buildx">https://github.com/docker-practice/docker-hub-buildx</a></p>
<h3 id="c0d9f81cf49fbc2ef92b4f8e1e26d5ce"><code>Dockerfile</code> 新增指令详解</h3>
<p>启用 <code>BuildKit</code> 之后，我们可以使用下面几个新的 <code>Dockerfile</code> 指令来加快镜像构建。</p>
<h4 id="f3fbfb080b75bcde89ea2c047ea7e0c0"><code>RUN --mount=type=cache</code></h4>
<p>目前，几乎所有的程序都会使用依赖管理工具，例如 <code>Go</code> 中的 <code>go mod</code>、<code>Node.js</code> 中的 <code>npm</code> 等等，当我们构建一个镜像时，往往会重复的从互联网中获取依赖包，难以缓存，大大降低了镜像的构建效率。</p>
<p>例如一个前端工程需要用到 <code>npm</code>：</p>
<pre><code class="language-docker">FROM node:alpine as builder

WORKDIR /app

COPY package.json /app/

RUN npm i --registry=https://registry.npm.taobao.org \
        &amp;&amp; rm -rf ~/.npm

COPY src /app/src

RUN npm run build

FROM nginx:alpine

COPY --from=builder /app/dist /app/dist</code></pre>
<p>使用多阶段构建，构建的镜像中只包含了目标文件夹 <code>dist</code>，但仍然存在一些问题，当 <code>package.json</code> 文件变动时，<code>RUN npm i &amp;&amp; rm -rf ~/.npm</code> 这一层会重新执行，变更多次后，生成了大量的中间层镜像。</p>
<p>为解决这个问题，进一步的我们可以设想一个类似 <strong>数据卷</strong> 的功能，在镜像构建时把 <code>node_modules</code> 文件夹挂载上去，在构建完成后，这个 <code>node_modules</code> 文件夹会自动卸载，实际的镜像中并不包含 <code>node_modules</code> 这个文件夹，这样我们就省去了每次获取依赖的时间，大大增加了镜像构建效率，同时也避免了生成了大量的中间层镜像。</p>
<p><code>BuildKit</code> 提供了 <code>RUN --mount=type=cache</code> 指令，可以实现上边的设想。</p>
<pre><code class="language-docker"># syntax = docker/dockerfile:experimental
FROM node:alpine as builder

WORKDIR /app

COPY package.json /app/

RUN --mount=type=cache,target=/app/node_modules,id=my_app_npm_module,sharing=locked \
    --mount=type=cache,target=/root/.npm,id=npm_cache \
        npm i --registry=https://registry.npm.taobao.org

COPY src /app/src

RUN --mount=type=cache,target=/app/node_modules,id=my_app_npm_module,sharing=locked \
# --mount=type=cache,target=/app/dist,id=my_app_dist,sharing=locked \
        npm run build

FROM nginx:alpine

# COPY --from=builder /app/dist /app/dist

# 为了更直观的说明 from 和 source 指令，这里使用 RUN 指令
RUN --mount=type=cache,target=/tmp/dist,from=builder,source=/app/dist \
    # --mount=type=cache,target/tmp/dist,from=my_app_dist,sharing=locked \
    mkdir -p /app/dist &amp;&amp; cp -r /tmp/dist/* /app/dist</code></pre>
<p><strong>由于 <code>BuildKit</code> 为实验特性，每个 <code>Dockerfile</code> 文件开头都必须加上如下指令</strong></p>
<pre><code class="language-docker"># syntax = docker/dockerfile:experimental</code></pre>
<p>第一个 <code>RUN</code> 指令执行后，<code>id</code> 为 <code>my_app_npm_module</code> 的缓存文件夹挂载到了 <code>/app/node_modules</code> 文件夹中。多次执行也不会产生多个中间层镜像。</p>
<p>第二个 <code>RUN</code> 指令执行时需要用到 <code>node_modules</code> 文件夹，<code>node_modules</code> 已经挂载，命令也可以正确执行。</p>
<p>第三个 <code>RUN</code> 指令将上一阶段产生的文件复制到指定位置，<code>from</code> 指明缓存的来源，这里 <code>builder</code> 表示缓存来源于构建的第一阶段，<code>source</code> 指明缓存来源的文件夹。</p>
<p>上面的 <code>Dockerfile</code> 中 <code>--mount=type=cache,...</code> 中指令作用如下：</p>
<table>
<thead>
<tr>
<th>Option</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>id</code></td>
<td><code>id</code> 设置一个标志，以便区分缓存。</td>
</tr>
<tr>
<td><code>target</code> (必填项)</td>
<td>缓存的挂载目标文件夹。</td>
</tr>
<tr>
<td><code>ro</code>,<code>readonly</code></td>
<td>只读，缓存文件夹不能被写入。</td>
</tr>
<tr>
<td><code>sharing</code></td>
<td>有 <code>shared</code> <code>private</code> <code>locked</code> 值可供选择。<code>sharing</code> 设置当一个缓存被多次使用时的表现，由于 <code>BuildKit</code> 支持并行构建，当多个步骤使用同一缓存时（同一 <code>id</code>）会发生冲突。<code>shared</code> 表示多个步骤可以同时读写，<code>private</code> 表示当多个步骤使用同一缓存时，每个步骤使用不同的缓存，<code>locked</code> 表示当一个步骤完成释放缓存后，后一个步骤才能继续使用该缓存。</td>
</tr>
<tr>
<td><code>from</code></td>
<td>缓存来源（构建阶段），不填写时为空文件夹。</td>
</tr>
<tr>
<td><code>source</code></td>
<td>来源的文件夹路径。</td>
</tr>
</tbody>
</table>
<h4 id="7c7395512bd319944e8b9ff102c97f01"><code>RUN --mount=type=bind</code></h4>
<p>该指令可以将一个镜像（或上一构建阶段）的文件挂载到指定位置。</p>
<pre><code class="language-docker"># syntax = docker/dockerfile:experimental
RUN --mount=type=bind,from=php:alpine,source=/usr/local/bin/docker-php-entrypoint,target=/docker-php-entrypoint \
        cat /docker-php-entrypoint</code></pre>
<h4 id="04d3bbd68315e99c72e616a83c41249b"><code>RUN --mount=type=tmpfs</code></h4>
<p>该指令可以将一个 <code>tmpfs</code> 文件系统挂载到指定位置。</p>
<pre><code class="language-docker"># syntax = docker/dockerfile:experimental
RUN --mount=type=tmpfs,target=/temp \
        mount | grep /temp</code></pre>
<h4 id="924cf332fdf589280cc69a1d9d1e1ea6"><code>RUN --mount=type=secret</code></h4>
<p>该指令可以将一个文件(例如密钥)挂载到指定位置。</p>
<pre><code class="language-docker"># syntax = docker/dockerfile:experimental
RUN --mount=type=secret,id=aws,target=/root/.aws/credentials \
        cat /root/.aws/credentials</code></pre>
<pre><code class="language-bash">$ docker build -t test --secret id=aws,src=$HOME/.aws/credentials .</code></pre>
<h4 id="8449dab7670b82a480be1cef25c0e9d8"><code>RUN --mount=type=ssh</code></h4>
<p>该指令可以挂载 <code>ssh</code> 密钥。</p>
<pre><code class="language-docker"># syntax = docker/dockerfile:experimental
FROM alpine
RUN apk add --no-cache openssh-client
RUN mkdir -p -m 0700 ~/.ssh &amp;&amp; ssh-keyscan gitlab.com &gt;&gt; ~/.ssh/known_hosts
RUN --mount=type=ssh ssh git@gitlab.com | tee /hello</code></pre>
<pre><code class="language-bash">$ eval $(ssh-agent)
$ ssh-add ~/.ssh/id_rsa
(Input your passphrase here)
$ docker build -t test --ssh default=$SSH_AUTH_SOCK .</code></pre>
<h3 id="cb454b1425e9fd00ad466723de2b49dc">docker-compose build 使用 Buildkit</h3>
<p>设置 <code>COMPOSE_DOCKER_CLI_BUILD=1</code> 环境变量即可使用。</p>
<h3 id="992792a653fcb3d29eb9f1e11e39f623">官方文档</h3>
<ul>
<li><a href="https://github.com/moby/buildkit/blob/master/frontend/dockerfile/docs/experimental.md">https://github.com/moby/buildkit/blob/master/frontend/dockerfile/docs/experimental.md</a></li>
</ul>
<h2 id="eeea5b189c3002d8e00d7e561a4d9a95">使用 Buildx 构建镜像</h2>
<h3 id="ecff77a8d4263545654ce610eacf996b">使用</h3>
<p>你可以直接使用 <code>docker buildx build</code> 命令构建镜像。</p>
<pre><code class="language-bash">$ docker buildx build .
[+] Building 8.4s (23/32)
 =&gt; ...</code></pre>
<p>Buildx 使用 <a href="https://wangmaolin.net/topic/Docker/buildkit.md">BuildKit 引擎</a> 进行构建，支持许多新的功能，具体参考 <a href="https://wangmaolin.net/topic/Docker/buildkit.md">Buildkit</a> 一节。</p>
<h3 id="992792a653fcb3d29eb9f1e11e39f623">官方文档</h3>
<ul>
<li><a href="https://docs.docker.com/engine/reference/commandline/buildx/">https://docs.docker.com/engine/reference/commandline/buildx/</a></li>
</ul>
<h2 id="5b485ff29609aa6d9e60c6a16cc45f8d">使用 buildx 构建多种系统架构支持的 Docker 镜像</h2>
<p>在之前的版本中构建多种系统架构支持的 Docker 镜像，要想使用统一的名字必须使用 <a href="https://wangmaolin.net/topic/image/manifest.md"><code>$ docker manifest</code></a> 命令。</p>
<p>在 Docker 19.03+ 版本中可以使用 <code>$ docker buildx build</code> 命令使用 <code>BuildKit</code> 构建镜像。该命令支持 <code>--platform</code> 参数可以同时构建支持多种系统架构的 Docker 镜像，大大简化了构建步骤。</p>
<h3 id="53e6c40f5f64e01cdfa89d8bc38f0806">新建 <code>builder</code> 实例</h3>
<p>Docker for Linux 不支持构建 <code>arm</code> 架构镜像，我们可以运行一个新的容器让其支持该特性，Docker 桌面版无需进行此项设置。</p>
<pre><code class="language-bash">$ docker run --rm --privileged tonistiigi/binfmt:latest --install all</code></pre>
<p>由于 Docker 默认的 <code>builder</code> 实例不支持同时指定多个 <code>--platform</code>，我们必须首先创建一个新的 <code>builder</code> 实例。同时由于国内拉取镜像较缓慢，我们可以使用配置了 <a href="https://github.com/moby/buildkit/blob/master/docs/buildkitd.toml.md">镜像加速地址</a>  的 <a href="https://github.com/docker-practice/buildx"><code>dockerpracticesig/buildkit:master</code></a> 镜像替换官方镜像。</p>
<blockquote>
<p>如果你有私有的镜像加速器，可以基于 <a href="https://github.com/docker-practice/buildx">https://github.com/docker-practice/buildx</a> 构建自己的 buildkit 镜像并使用它。</p>
</blockquote>
<pre><code class="language-bash"># 适用于国内环境
$ docker buildx create --use --name=mybuilder-cn --driver docker-container --driver-opt image=dockerpracticesig/buildkit:master

# 适用于腾讯云环境(腾讯云主机、coding.net 持续集成)
$ docker buildx create --use --name=mybuilder-cn --driver docker-container --driver-opt image=dockerpracticesig/buildkit:master-tencent

# $ docker buildx create --name mybuilder --driver docker-container

$ docker buildx use mybuilder</code></pre>
<h3 id="0cd7fc52e88767f46089b6fc4bc14cdc">构建镜像</h3>
<p>新建 Dockerfile 文件。</p>
<pre><code class="language-docker">FROM --platform=$TARGETPLATFORM alpine

RUN uname -a &gt; /os.txt

CMD cat /os.txt</code></pre>
<p>使用 <code>$ docker buildx build</code> 命令构建镜像，注意将 <code>myusername</code> 替换为自己的 Docker Hub 用户名。</p>
<p><code>--push</code> 参数表示将构建好的镜像推送到 Docker 仓库。</p>
<pre><code class="language-bash">$ docker buildx build --platform linux/arm,linux/arm64,linux/amd64 -t myusername/hello . --push

# 查看镜像信息
$ docker buildx imagetools inspect myusername/hello</code></pre>
<p>在不同架构运行该镜像，可以得到该架构的信息。</p>
<pre><code class="language-bash"># arm
$ docker run -it --rm myusername/hello
Linux buildkitsandbox 4.9.125-linuxkit #1 SMP Fri Sep 7 08:20:28 UTC 2018 armv7l Linux

# arm64
$ docker run -it --rm myusername/hello
Linux buildkitsandbox 4.9.125-linuxkit #1 SMP Fri Sep 7 08:20:28 UTC 2018 aarch64 Linux

# amd64
$ docker run -it --rm myusername/hello
Linux buildkitsandbox 4.9.125-linuxkit #1 SMP Fri Sep 7 08:20:28 UTC 2018 x86_64 Linux</code></pre>
<h3 id="be575b982a98e2243746ab5ac55d5166">架构相关变量</h3>
<p><code>Dockerfile</code> 支持如下架构相关的变量</p>
<p><strong>TARGETPLATFORM</strong> </p>
<p>构建镜像的目标平台，例如 <code>linux/amd64</code>, <code>linux/arm/v7</code>, <code>windows/amd64</code>。</p>
<p><strong>TARGETOS</strong> </p>
<p><code>TARGETPLATFORM</code> 的 OS 类型，例如 <code>linux</code>, <code>windows</code></p>
<p><strong>TARGETARCH</strong> </p>
<p><code>TARGETPLATFORM</code> 的架构类型，例如 <code>amd64</code>, <code>arm</code></p>
<p><strong>TARGETVARIANT</strong></p>
<p><code>TARGETPLATFORM</code> 的变种，该变量可能为空，例如 <code>v7</code></p>
<p><strong>BUILDPLATFORM</strong></p>
<p>构建镜像主机平台，例如 <code>linux/amd64</code></p>
<p><strong>BUILDOS</strong> </p>
<p><code>BUILDPLATFORM</code> 的 OS 类型，例如 <code>linux</code></p>
<p><strong>BUILDARCH</strong> </p>
<p><code>BUILDPLATFORM</code> 的架构类型，例如 <code>amd64</code></p>
<p><strong>BUILDVARIANT</strong> </p>
<p><code>BUILDPLATFORM</code> 的变种，该变量可能为空，例如 <code>v7</code></p>
<h4 id="017d5afb1e96722f97e5ae0f3af05bb7">使用举例</h4>
<p>例如我们要构建支持 <code>linux/arm/v7</code> 和 <code>linux/amd64</code> 两种架构的镜像。假设已经生成了两个平台对应的二进制文件：</p>
<ul>
<li><code>bin/dist-linux-arm</code></li>
<li><code>bin/dist-linux-amd64</code></li>
</ul>
<p>那么 <code>Dockerfile</code> 可以这样书写：</p>
<pre><code class="language-docker">FROM scratch

# 使用变量必须申明
ARG TARGETOS

ARG TARGETARCH

COPY bin/dist-${TARGETOS}-${TARGETARCH} /dist

ENTRYPOINT ["dist"]</code></pre><h4 style="text-align:left;line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont, Helvetica Neue, PingFang SC, Hiragino Sans GB , Microsoft YaHei UI , Microsoft YaHei ,Arial,sans-serif;font-size:14px;font-weight:bold;margin:2em 8px 0.5em;color:rgba(250, 81, 81, 1)">引用链接</h4><p style="text-align:left;line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont, Helvetica Neue, PingFang SC, Hiragino Sans GB , Microsoft YaHei UI , Microsoft YaHei ,Arial,sans-serif;font-size:80%;margin:0.5em 8px;color:#3f3f3f"><code style="font-size: 90%; opacity: 0.6;">[1]</code> Moby BuildKit: <i><a href="https://wangmaolin.net/topic/Docker/buildkit.md" target="_blank">buildkit.md</a></i><br><code style="font-size: 90%; opacity: 0.6;">[2]</code> BuildKit 引擎: <i><a href="https://wangmaolin.net/topic/Docker/buildkit.md" target="_blank">buildkit.md</a></i><br><code style="font-size: 90%; opacity: 0.6;">[3]</code> Buildkit: <i><a href="https://wangmaolin.net/topic/Docker/buildkit.md" target="_blank">buildkit.md</a></i><br><code style="font-size: 90%; opacity: 0.6;">[4]</code> `$ docker manifest`: <i><a href="https://wangmaolin.net/topic/image/manifest.md" target="_blank">../image/manifest.md</a></i><br><code style="font-size: 90%; opacity: 0.6;">[5]</code> 镜像加速地址: <i><a href="https://github.com/moby/buildkit/blob/master/docs/buildkitd.toml.md" target="_blank">https://github.com/moby/buildkit/blob/master/docs/buildkitd.toml.md</a></i><br><code style="font-size: 90%; opacity: 0.6;">[6]</code> `dockerpracticesig/buildkit:master`: <i><a href="https://github.com/docker-practice/buildx" target="_blank">https://github.com/docker-practice/buildx</a></i><br></p>
			</div>
</div>

            <larecipe-back-to-top></larecipe-back-to-top>
        </div>


        <script>
            window.config = [];
        </script>

        <script type="text/javascript">
            if(localStorage.getItem('larecipeSidebar') == null) {
                localStorage.setItem('larecipeSidebar', !! 1);
            }
        </script>

        <script src="../../vendor/binarytorch/larecipe/assets/js/app.js"></script>

        <script>
            window.LaRecipe = new CreateLarecipe(config)
        </script>

        <!-- Google Analytics -->
                <!-- /Google Analytics -->

        
        <script>
            LaRecipe.run()
        </script>
    </body>
</html>
