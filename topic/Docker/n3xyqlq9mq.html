<!doctype html>
<html>
    <head>
        <!-- META Tags -->
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>Docker Etcd | 风中的木偶</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <!-- SEO -->
        <meta name="author" content="风中的木偶">
        <meta name="description" content="">
        <meta name="keywords" content="木偶笔记,个人技术博客,IT技术笔记,博客,个人网站,风中的木偶,木偶">
        <meta name="twitter:card" value="summary">
                                                                <meta property="og:title" content="风中的木偶个人博客" />
                                                                <meta property="og:type" content="article" />
                                                                <meta property="og:url" content="https://wangmaolin.net" />
                                                                                            
        <!-- CSS -->
        <link rel="stylesheet" href="../../vendor/binarytorch/larecipe/assets/css/app.css">

        
        <!-- FontAwesome -->
        <link rel="stylesheet" href="../../vendor/binarytorch/larecipe/assets/css/font-awesome.css">
                    <link rel="stylesheet" href="../../vendor/binarytorch/larecipe/assets/css/font-awesome-v4-shims.css">
        
        <!-- Dynamic Colors -->
        <style>
    :root {
        --primary: #787AF6;
        --secondary: #2b9cf2;
    }

    :not(pre)>code[class*=language-], pre[class*=language-] {
        border-top: 3px solid #787AF6;
    }
    
    .bg-gradient-primary {
        background: linear-gradient(87deg, #787AF6 0, #2b9cf2 100%) !important;
    }

    [v-cloak] > * { 
        display: none; 
    }
    
    [v-cloak]::before { 
        content: " ";
        position: absolute;
        width: 100%;
        height: 100%;
        background-color: #F2F6FA;
    }
</style>
        <!-- CSRF Token -->
        <meta name="csrf-token" content="Pahvyn05xLeGT7ZyAH8zdtrdERAneaW7crP5Dk0P">

        
    </head>
    <body>
        <div id="app" v-cloak>
            <div class="fixed pin-t pin-x z-40">
    <div class="bg-gradient-primary text-white h-1"></div>

    <nav class="flex items-center justify-between text-black bg-navbar shadow-xs h-16">
        <div class="flex items-center flex-no-shrink">
            <a href="../../index.html" class="flex items-center flex-no-shrink text-black mx-4">
                
                <p class="inline-block font-semibold mx-1 text-grey-dark">
                    风中的木偶
                </p>
            </a>

            <div class="switch">
                <input type="checkbox" name="1" id="1" v-model="sidebar" class="switch-checkbox"/>
                <label class="switch-label" for="1"></label>
            </div>
        </div>

        <div class="hidden lg:flex items-center justify-end pr-4">
            <div class="relative">
                <form action="https://wangmaolin.net/search" onsubmit="return validateForm()" class="form-search">
                    <input id="search-input" name="q" type="text" placeholder="Search" class="bg-gray-100 appearance-none border-2 border-gray-200 rounded py-2 px-4
         text-gray-800 leading-tight focus:outline-none focus:bg-white focus:border-gray-500">
                </form>
            </div>
        </div>

        <div class="block mx-4 flex items-center">
                        
            
            
            
            

            
            <larecipe-dropdown>
                <larecipe-button type="primary" class="flex">
                    Docker <i class="mx-1 fa fa-angle-down"></i>
                </larecipe-button>

                <template slot="list">
                    <ul class="list-reset" style="height: 800px;width: 200px">
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../AI/overview.html">AI</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../APP/overview.html">APP</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../CSS/overview.html">CSS</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="overview.html">Docker</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../ELK/overview.html">ELK</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Git/overview.html">Git</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Go语言/overview.html">Go语言</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Laravel/overview.html">Laravel</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Linux/overview.html">Linux</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Linux&#32;服务器配置/overview.html">Linux 服务器配置</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Mac/overview.html">Mac</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../MongoDB/overview.html">MongoDB</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Mqtt/overview.html">Mqtt</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../MySQL/overview.html">MySQL</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Nginx/overview.html">Nginx</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../PHP/overview.html">PHP</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Protobuf/overview.html">Protobuf</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Python/overview.html">Python</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../SEO/overview.html">SEO</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Vue&#32;教程/overview.html">Vue 教程</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Windows/overview.html">Windows</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../webman/overview.html">webman</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../一无所有到财富自由/overview.html">一无所有到财富自由</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../云服务/overview.html">云服务</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../产品/overview.html">产品</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../元宇宙/overview.html">元宇宙</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../前端/overview.html">前端</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../合伙的本质/overview.html">合伙的本质</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../商业/overview.html">商业</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../大数据/overview.html">大数据</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../天机38局/overview.html">天机38局</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../开源项目/overview.html">开源项目</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../微信/overview.html">微信</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../控糖革命/overview.html">控糖革命</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../搜索/overview.html">搜索</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../支付/overview.html">支付</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../智慧人生/overview.html">智慧人生</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../架构/overview.html">架构</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../游戏开发/overview.html">游戏开发</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../算法/overview.html">算法</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../缓存/overview.html">缓存</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../网络/overview.html">网络</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../自媒体/overview.html">自媒体</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../菜谱/overview.html">菜谱</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../设计模式/overview.html">设计模式</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../资源/overview.html">资源</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../软件工具/overview.html">软件工具</a>
                            </li>
                                            </ul>
                </template>
            </larecipe-dropdown>
            

                    </div>
    </nav>
</div>

            
            <div>
	<div class="sidebar" :class="[{'is-hidden': ! sidebar}]">
    <ul>
<li>
<h2>服务</h2>
<ul>
<li id="blog280"><a href="gxpv5kwv86.html#blog280">使用 docker 安装 MySql</a>
<li id="blog449"><a href="nxq9zzj9do.html#blog449">使用 docker 安装 Redis</a>
<li id="blog503"><a href="k3dyk3n9l0.html#blog503">使用 Docker 安装 LInux 容器</a>
<li id="blog504"><a href="jenydzd97d.html#blog504">使用Docker 安装 xunsearch 容器</a>
</ul>
</li>
<li>
<h2>Docker</h2>
<ul>
<li id="blog494"><a href="j3oyjzx9p5.html#blog494">Docker 简介</a>
<li id="blog495"><a href="x2ev84o9or.html#blog495">Docker 的基本概念</a>
<li id="blog496"><a href="de296qwyq7.html#blog496">Docker 镜像介绍</a>
<li id="blog497"><a href="nxq9z0jvdo.html#blog497">Dockerfile 详解</a>
<li id="blog498"><a href="62wy3g39km.html#blog498">Docker 容器介绍</a>
<li id="blog499"><a href="k3dyk3o9l0.html#blog499">Docker 仓库介绍</a>
<li id="blog500"><a href="de296qqyq7.html#blog500">Docker 数据管理</a>
<li id="blog501"><a href="nxq9z03vdo.html#blog501">Docker 中的网络功能介绍</a>
<li id="blog502"><a href="62wy3gr9km.html#blog502">Docker 高级网络配置</a>
<li id="blog505"><a href="15dve32y4x.html#blog505">Docker Swarm mode 介绍</a>
<li id="blog506"><a href="34rvgdevdj.html#blog506">Docker 安全</a>
<li id="blog507"><a href="wkl9n4myz4.html#blog507">Docker 底层实现</a>
<li id="blog508"><a href="gxpv50qy86.html#blog508">Docker Buildx</a>
<li id="blog509"><a href="n3xyqlq9mq.html#blog509">Docker Etcd</a>
<li id="blog510"><a href="4x3voxmvm1.html#blog510">Docker 常见问题总结</a>
<li id="blog511"><a href="3qk94rlyw1.html#blog511">Docker 命令</a>
<li id="blog512"><a href="x569x6k9ep.html#blog512">Dockerfile 最佳实践</a>
</ul>
</li>
</ul>
</div>

<style>
    #cnzz_stat_icon_1280630928
    {
        display: none;
    }
</style>

<script src="../../vendor/binarytorch/larecipe/assets/js/jquery.min.js"></script>
<script src="../../modules/blog/js/detail.js"></script>

<script type="text/javascript">
    $(function () {
        var cid = 'n3xyqlq9mq.html';
        if (!checkView(cid)) {
            $.get('https://wangmaolin.net/api/blog/addView/article/n3xyqlq9mq.html', function (data, status) {
                addView('n3xyqlq9mq.html')
            });
        }
    });
</script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?7c12b9716af39eb368cff4a19aa89393";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7125202304422722"
     crossorigin="anonymous"></script>
	
	<div class="documentation is-dark" :class="{'expanded': ! sidebar}">
		<h1>Docker Etcd</h1><ul>
<li><a href="n3xyqlq9mq.html#a226e9fbdfc1c8dd7e7fef4d333f86ed">etcd</a></li>
<li><a href="n3xyqlq9mq.html#eab610b3b4ae746f8927227a5399473e">什么是 etcd</a></li>
<li><a href="n3xyqlq9mq.html#e655a410ff21cd07e7a0150491e04371">安装</a>
<ul>
<li><a href="n3xyqlq9mq.html#f7b447a2cc0e28e9a95390a3238ca031">二进制文件方式下载</a></li>
<li><a href="n3xyqlq9mq.html#9572dcd88d62e4d68822087435ad1125">Docker 镜像方式运行</a></li>
<li><a href="n3xyqlq9mq.html#148205a847c50580bdf248ac12889dee">macOS 中运行</a></li>
</ul></li>
<li><a href="n3xyqlq9mq.html#14670adb703689d79bac836689b78017">etcd 集群</a></li>
<li><a href="n3xyqlq9mq.html#eb2541fd9e907a3f76bce0b42cf253c1">使用 etcdctl</a>
<ul>
<li><a href="n3xyqlq9mq.html#1475e8cb4633b25db26bd0b484bfc45f">数据库操作</a>
<ul>
<li><a href="n3xyqlq9mq.html#8e13ffc9fd9d6a6761231a764bdf106b">put</a></li>
<li><a href="n3xyqlq9mq.html#b5eda0a74558a342cf659187f06f746f">get</a></li>
<li><a href="n3xyqlq9mq.html#d2bcc286168bf8e040885c5cb7b6df13">del</a></li>
</ul></li>
<li><a href="n3xyqlq9mq.html#fb2f9ec0fa1cfef61ee8f314d92acc66">非数据库操作</a>
<ul>
<li><a href="n3xyqlq9mq.html#d2974c96dc96b3f30a6168bcc4b25b02">watch</a></li>
<li><a href="n3xyqlq9mq.html#aa08769cdcb26674c6706093503ff0a3">member</a></li>
</ul></li>
</ul></li>
</ul><h2 id="a226e9fbdfc1c8dd7e7fef4d333f86ed">etcd</h2>
<p><code>etcd</code> 是 <code>CoreOS</code> 团队发起的一个管理配置信息和服务发现（<code>Service Discovery</code>）的项目，在这一章里面，我们将基于 <code>etcd 3.x</code> 版本介绍该项目的目标，安装和使用，以及实现的技术。</p>
<h2 id="eab610b3b4ae746f8927227a5399473e">什么是 etcd</h2>
<p><code>etcd</code> 是 <code>CoreOS</code> 团队于 2013 年 6 月发起的开源项目，它的目标是构建一个高可用的分布式键值（<code>key-value</code>）数据库，基于 <code>Go</code> 语言实现。我们知道，在分布式系统中，各种服务的配置信息的管理分享，服务的发现是一个很基本同时也是很重要的问题。<code>CoreOS</code> 项目就希望基于 <code>etcd</code> 来解决这一问题。</p>
<p><code>etcd</code> 目前在 <a href="https://github.com/etcd-io/etcd">github.com/etcd-io/etcd</a> 进行维护。</p>
<p>受到 <a href="https://zookeeper.apache.org/">Apache ZooKeeper</a> 项目和 <a href="https://github.com/ha/doozerd">doozer</a> 项目的启发，<code>etcd</code> 在设计的时候重点考虑了下面四个要素：</p>
<ul>
<li>
<p>简单：具有定义良好、面向用户的 <code>API</code> (<a href="https://github.com/grpc/grpc">gRPC</a>)</p>
</li>
<li>
<p>安全：支持 <code>HTTPS</code> 方式的访问</p>
</li>
<li>
<p>快速：支持并发 <code>10 k/s</code> 的写操作</p>
</li>
<li>
<p>可靠：支持分布式结构，基于 <code>Raft</code> 的一致性算法</p>
</li>
</ul>
<p><em>Apache ZooKeeper 是一套知名的分布式系统中进行同步和一致性管理的工具。</em></p>
<p><em>doozer 是一个一致性分布式数据库。</em></p>
<p><em><a href="https://raft.github.io/">Raft</a> 是一套通过选举主节点来实现分布式系统一致性的算法，相比于大名鼎鼎的 Paxos 算法，它的过程更容易被人理解，由 Stanford 大学的 Diego Ongaro 和 John Ousterhout 提出。更多细节可以参考 <a href="http://raftconsensus.github.io">raftconsensus.github.io</a>。</em></p>
<p>一般情况下，用户使用 <code>etcd</code> 可以在多个节点上启动多个实例，并添加它们为一个集群。同一个集群中的 <code>etcd</code> 实例将会保持彼此信息的一致性。</p>
<h2 id="e655a410ff21cd07e7a0150491e04371">安装</h2>
<p><code>etcd</code> 基于 <code>Go</code> 语言实现，因此，用户可以从 <a href="https://github.com/etcd-io/etcd">项目主页</a> 下载源代码自行编译，也可以下载编译好的二进制文件，甚至直接使用制作好的 <code>Docker</code> 镜像文件来体验。</p>
<blockquote>
<p>注意：本章节内容基于 etcd <code>3.4.x</code> 版本</p>
</blockquote>
<h3 id="f7b447a2cc0e28e9a95390a3238ca031">二进制文件方式下载</h3>
<p>编译好的二进制文件都在 <a href="https://github.com/etcd-io/etcd/releases/">github.com/etcd-io/etcd/releases</a> 页面，用户可以选择需要的版本，或通过下载工具下载。</p>
<p>例如，使用 <code>curl</code> 工具下载压缩包，并解压。</p>
<pre><code class="language-bash">$ curl -L https://github.com/etcd-io/etcd/releases/download/v3.4.0/etcd-v3.4.0-linux-amd64.tar.gz -o etcd-v3.4.0-linux-amd64.tar.gz

# 国内用户可以使用以下方式加快下载
$ curl -L https://download.fastgit.org/etcd-io/etcd/releases/download/v3.4.0/etcd-v3.4.0-linux-amd64.tar.gz -o etcd-v3.4.0-linux-amd64.tar.gz

$ tar xzvf etcd-v3.4.0-linux-amd64.tar.gz
$ cd etcd-v3.4.0-linux-amd64</code></pre>
<p>解压后，可以看到文件包括</p>
<pre><code class="language-bash">$ ls
Documentation README-etcdctl.md README.md READMEv2-etcdctl.md etcd etcdctl</code></pre>
<p>其中 <code>etcd</code> 是服务主文件，<code>etcdctl</code> 是提供给用户的命令客户端，其他文件是支持文档。</p>
<p>下面将 <code>etcd</code> <code>etcdctl</code> 文件放到系统可执行目录（例如 <code>/usr/local/bin/</code>）。</p>
<pre><code class="language-bash">$ sudo cp etcd* /usr/local/bin/</code></pre>
<p>默认 <code>2379</code> 端口处理客户端的请求，<code>2380</code> 端口用于集群各成员间的通信。启动 <code>etcd</code> 显示类似如下的信息：</p>
<pre><code class="language-bash">$ etcd
...
2017-12-03 11:18:34.411579 I | embed: listening for peers on http://localhost:2380
2017-12-03 11:18:34.411938 I | embed: listening for client requests on localhost:2379</code></pre>
<p>此时，可以使用 <code>etcdctl</code> 命令进行测试，设置和获取键值 <code>testkey: "hello world"</code>，检查 <code>etcd</code> 服务是否启动成功：</p>
<pre><code class="language-bash">$ ETCDCTL_API=3 etcdctl member list
8e9e05c52164694d, started, default, http://localhost:2380, http://localhost:2379

$ ETCDCTL_API=3 etcdctl put testkey "hello world"
OK

$ etcdctl get testkey
testkey
hello world</code></pre>
<p>说明 etcd 服务已经成功启动了。</p>
<h3 id="9572dcd88d62e4d68822087435ad1125">Docker 镜像方式运行</h3>
<p>镜像名称为 <code>quay.io/coreos/etcd</code>，可以通过下面的命令启动 <code>etcd</code> 服务监听到 <code>2379</code> 和 <code>2380</code> 端口。</p>
<pre><code class="language-bash">$ docker run \
-p 2379:2379 \
-p 2380:2380 \
--mount type=bind,source=/tmp/etcd-data.tmp,destination=/etcd-data \
--name etcd-gcr-v3.4.0 \
quay.io/coreos/etcd:v3.4.0 \
/usr/local/bin/etcd \
--name s1 \
--data-dir /etcd-data \
--listen-client-urls http://0.0.0.0:2379 \
--advertise-client-urls http://0.0.0.0:2379 \
--listen-peer-urls http://0.0.0.0:2380 \
--initial-advertise-peer-urls http://0.0.0.0:2380 \
--initial-cluster s1=http://0.0.0.0:2380 \
--initial-cluster-token tkn \
--initial-cluster-state new \
--log-level info \
--logger zap \
--log-outputs stderr</code></pre>
<p>打开新的终端按照上一步的方法测试 <code>etcd</code> 是否成功启动。</p>
<h3 id="148205a847c50580bdf248ac12889dee">macOS 中运行</h3>
<pre><code class="language-bash">$ brew install etcd

$ etcd

$ etcdctl member list</code></pre>
<h2 id="14670adb703689d79bac836689b78017">etcd 集群</h2>
<p>下面我们使用 Docker Compose 模拟启动一个 3 节点的 <code>etcd</code> 集群。</p>
<p>编辑 <code>docker-compose.yml</code> 文件</p>
<pre><code class="language-yaml">version: "3.6"
services:

  node1:
    image: quay.io/coreos/etcd:v3.4.0
    volumes:
      - node1-data:/etcd-data
    expose:
      - 2379
      - 2380
    networks:
      cluster_net:
        ipv4_address: 172.16.238.100
    environment:
      - ETCDCTL_API=3
    command:
      - /usr/local/bin/etcd
      - --data-dir=/etcd-data
      - --name
      - node1
      - --initial-advertise-peer-urls
      - http://172.16.238.100:2380
      - --listen-peer-urls
      - http://0.0.0.0:2380
      - --advertise-client-urls
      - http://172.16.238.100:2379
      - --listen-client-urls
      - http://0.0.0.0:2379
      - --initial-cluster
      - node1=http://172.16.238.100:2380,node2=http://172.16.238.101:2380,node3=http://172.16.238.102:2380
      - --initial-cluster-state
      - new
      - --initial-cluster-token
      - docker-etcd

  node2:
    image: quay.io/coreos/etcd:v3.4.0
    volumes:
      - node2-data:/etcd-data
    networks:
      cluster_net:
        ipv4_address: 172.16.238.101
    environment:
      - ETCDCTL_API=3
    expose:
      - 2379
      - 2380
    command:
      - /usr/local/bin/etcd
      - --data-dir=/etcd-data
      - --name
      - node2
      - --initial-advertise-peer-urls
      - http://172.16.238.101:2380
      - --listen-peer-urls
      - http://0.0.0.0:2380
      - --advertise-client-urls
      - http://172.16.238.101:2379
      - --listen-client-urls
      - http://0.0.0.0:2379
      - --initial-cluster
      - node1=http://172.16.238.100:2380,node2=http://172.16.238.101:2380,node3=http://172.16.238.102:2380
      - --initial-cluster-state
      - new
      - --initial-cluster-token
      - docker-etcd

  node3:
    image: quay.io/coreos/etcd:v3.4.0
    volumes:
      - node3-data:/etcd-data
    networks:
      cluster_net:
        ipv4_address: 172.16.238.102
    environment:
      - ETCDCTL_API=3
    expose:
      - 2379
      - 2380
    command:
      - /usr/local/bin/etcd
      - --data-dir=/etcd-data
      - --name
      - node3
      - --initial-advertise-peer-urls
      - http://172.16.238.102:2380
      - --listen-peer-urls
      - http://0.0.0.0:2380
      - --advertise-client-urls
      - http://172.16.238.102:2379
      - --listen-client-urls
      - http://0.0.0.0:2379
      - --initial-cluster
      - node1=http://172.16.238.100:2380,node2=http://172.16.238.101:2380,node3=http://172.16.238.102:2380
      - --initial-cluster-state
      - new
      - --initial-cluster-token
      - docker-etcd

volumes:
  node1-data:
  node2-data:
  node3-data:

networks:
  cluster_net:
    driver: bridge
    ipam:
      driver: default
      config:
      -
        subnet: 172.16.238.0/24</code></pre>
<p>使用 <code>docker-compose up</code> 启动集群之后使用 <code>docker exec</code> 命令登录到任一节点测试 <code>etcd</code> 集群。</p>
<pre><code class="language-bash">/ # etcdctl member list
daf3fd52e3583ff, started, node3, http://172.16.238.102:2380, http://172.16.238.102:2379
422a74f03b622fef, started, node1, http://172.16.238.100:2380, http://172.16.238.100:2379
ed635d2a2dbef43d, started, node2, http://172.16.238.101:2380, http://172.16.238.101:2379</code></pre>
<h2 id="eb2541fd9e907a3f76bce0b42cf253c1">使用 etcdctl</h2>
<p><code>etcdctl</code> 是一个命令行客户端，它能提供一些简洁的命令，供用户直接跟 <code>etcd</code> 服务打交道，而无需基于 <code>HTTP API</code> 方式。这在某些情况下将很方便，例如用户对服务进行测试或者手动修改数据库内容。我们也推荐在刚接触 <code>etcd</code> 时通过 <code>etcdctl</code> 命令来熟悉相关的操作，这些操作跟 <code>HTTP API</code> 实际上是对应的。</p>
<p><code>etcd</code> 项目二进制发行包中已经包含了 <code>etcdctl</code> 工具，没有的话，可以从 <a href="https://github.com/etcd-io/etcd/releases">github.com/etcd-io/etcd/releases</a> 下载。</p>
<p><code>etcdctl</code> 支持如下的命令，大体上分为数据库操作和非数据库操作两类，后面将分别进行解释。</p>
<pre><code class="   language-php">NAME:
    etcdctl - A simple command line client for etcd3.

USAGE:
    etcdctl

VERSION:
    3.4.0

API VERSION:
    3.4

COMMANDS:
    get         Gets the key or a range of keys
    put         Puts the given key into the store
    del         Removes the specified key or range of keys [key, range_end)
    txn         Txn processes all the requests in one transaction
    compaction      Compacts the event history in etcd
    alarm disarm        Disarms all alarms
    alarm list      Lists all alarms
    defrag          Defragments the storage of the etcd members with given endpoints
    endpoint health     Checks the healthiness of endpoints specified in `--endpoints` flag
    endpoint status     Prints out the status of endpoints specified in `--endpoints` flag
    watch           Watches events stream on keys or prefixes
    version         Prints the version of etcdctl
    lease grant     Creates leases
    lease revoke        Revokes leases
    lease timetolive    Get lease information
    lease keep-alive    Keeps leases alive (renew)
    member add      Adds a member into the cluster
    member remove       Removes a member from the cluster
    member update       Updates a member in the cluster
    member list     Lists all members in the cluster
    snapshot save       Stores an etcd node backend snapshot to a given file
    snapshot restore    Restores an etcd member snapshot to an etcd directory
    snapshot status     Gets backend snapshot status of a given file
    make-mirror     Makes a mirror at the destination etcd cluster
    migrate         Migrates keys in a v2 store to a mvcc store
    lock            Acquires a named lock
    elect           Observes and participates in leader election
    auth enable     Enables authentication
    auth disable        Disables authentication
    user add        Adds a new user
    user delete     Deletes a user
    user get        Gets detailed information of a user
    user list       Lists all users
    user passwd     Changes password of user
    user grant-role     Grants a role to a user
    user revoke-role    Revokes a role from a user
    role add        Adds a new role
    role delete     Deletes a role
    role get        Gets detailed information of a role
    role list       Lists all roles
    role grant-permission   Grants a key to a role
    role revoke-permission  Revokes a key from a role
    check perf      Check the performance of the etcd cluster
    help            Help about any command

OPTIONS:
      --cacert=""               verify certificates of TLS-enabled secure servers using this CA bundle
      --cert=""                 identify secure client using this TLS certificate file
      --command-timeout=5s          timeout for short running command (excluding dial timeout)
      --debug[=false]               enable client-side debug logging
      --dial-timeout=2s             dial timeout for client connections
      --endpoints=[127.0.0.1:2379]      gRPC endpoints
      --hex[=false]             print byte strings as hex encoded strings
      --insecure-skip-tls-verify[=false]    skip server certificate verification
      --insecure-transport[=true]       disable transport security for client connections
      --key=""                  identify secure client using this TLS key file
      --user=""                 username[:password] for authentication (prompt if password is not supplied)
  -w, --write-out="simple"          set the output format (fields, json, protobuf, simple, table)</code></pre>
<h3 id="1475e8cb4633b25db26bd0b484bfc45f">数据库操作</h3>
<p>数据库操作围绕对键值和目录的 CRUD （符合 REST 风格的一套操作：Create）完整生命周期的管理。</p>
<p>etcd 在键的组织上采用了层次化的空间结构（类似于文件系统中目录的概念），用户指定的键可以为单独的名字，如 <code>testkey</code>，此时实际上放在根目录 <code>/</code> 下面，也可以为指定目录结构，如 <code>cluster1/node2/testkey</code>，则将创建相应的目录结构。</p>
<blockquote>
<p>注：CRUD 即 Create, Read, Update, Delete，是符合 REST 风格的一套 API 操作。</p>
</blockquote>
<h4 id="8e13ffc9fd9d6a6761231a764bdf106b">put</h4>
<pre><code class="language-bash">$ etcdctl put /testdir/testkey "Hello world"
OK</code></pre>
<h4 id="b5eda0a74558a342cf659187f06f746f">get</h4>
<p>获取指定键的值。例如</p>
<pre><code class="language-bash">$ etcdctl put testkey hello
OK
$ etcdctl get testkey
testkey
hello</code></pre>
<p>支持的选项为</p>
<p><code>--sort</code>    对结果进行排序</p>
<p><code>--consistent</code> 将请求发给主节点，保证获取内容的一致性</p>
<h4 id="d2bcc286168bf8e040885c5cb7b6df13">del</h4>
<p>删除某个键值。例如</p>
<pre><code class="language-bash">$ etcdctl del testkey
1</code></pre>
<h3 id="fb2f9ec0fa1cfef61ee8f314d92acc66">非数据库操作</h3>
<h4 id="d2974c96dc96b3f30a6168bcc4b25b02">watch</h4>
<p>监测一个键值的变化，一旦键值发生更新，就会输出最新的值。</p>
<p>例如，用户更新 <code>testkey</code> 键值为 <code>Hello world</code>。</p>
<pre><code class="language-bash">$ etcdctl watch testkey
PUT
testkey
2</code></pre>
<h4 id="aa08769cdcb26674c6706093503ff0a3">member</h4>
<p>通过 <code>list</code>、<code>add</code>、<code>update</code>、<code>remove</code> 命令列出、添加、更新、删除 etcd 实例到 etcd 集群中。</p>
<p>例如本地启动一个 <code>etcd</code> 服务实例后，可以用如下命令进行查看。</p>
<pre><code class="language-bash">$ etcdctl member list
422a74f03b622fef, started, node1, http://172.16.238.100:2380, http://172.16.238.100:23</code></pre><h4 style="text-align:left;line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont, Helvetica Neue, PingFang SC, Hiragino Sans GB , Microsoft YaHei UI , Microsoft YaHei ,Arial,sans-serif;font-size:14px;font-weight:bold;margin:2em 8px 0.5em;color:rgba(250, 81, 81, 1)">引用链接</h4><p style="text-align:left;line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont, Helvetica Neue, PingFang SC, Hiragino Sans GB , Microsoft YaHei UI , Microsoft YaHei ,Arial,sans-serif;font-size:80%;margin:0.5em 8px;color:#3f3f3f"><code style="font-size: 90%; opacity: 0.6;">[1]</code> github.com/etcd-io/etcd: <i><a href="https://github.com/etcd-io/etcd" target="_blank">https://github.com/etcd-io/etcd</a></i><br><code style="font-size: 90%; opacity: 0.6;">[2]</code> Apache ZooKeeper: <i><a href="https://zookeeper.apache.org/" target="_blank">https://zookeeper.apache.org/</a></i><br><code style="font-size: 90%; opacity: 0.6;">[3]</code> doozer: <i><a href="https://github.com/ha/doozerd" target="_blank">https://github.com/ha/doozerd</a></i><br><code style="font-size: 90%; opacity: 0.6;">[4]</code> gRPC: <i><a href="https://github.com/grpc/grpc" target="_blank">https://github.com/grpc/grpc</a></i><br><code style="font-size: 90%; opacity: 0.6;">[5]</code> Raft: <i><a href="https://raft.github.io/" target="_blank">https://raft.github.io/</a></i><br><code style="font-size: 90%; opacity: 0.6;">[6]</code> raftconsensus.github.io: <i><a href="http://raftconsensus.github.io" target="_blank">http://raftconsensus.github.io</a></i><br><code style="font-size: 90%; opacity: 0.6;">[7]</code> 项目主页: <i><a href="https://github.com/etcd-io/etcd" target="_blank">https://github.com/etcd-io/etcd</a></i><br><code style="font-size: 90%; opacity: 0.6;">[8]</code> github.com/etcd-io/etcd/releases: <i><a href="https://github.com/etcd-io/etcd/releases/" target="_blank">https://github.com/etcd-io/etcd/releases/</a></i><br><code style="font-size: 90%; opacity: 0.6;">[9]</code> github.com/etcd-io/etcd/releases: <i><a href="https://github.com/etcd-io/etcd/releases" target="_blank">https://github.com/etcd-io/etcd/releases</a></i><br></p>
			</div>
</div>

            <larecipe-back-to-top></larecipe-back-to-top>
        </div>


        <script>
            window.config = [];
        </script>

        <script type="text/javascript">
            if(localStorage.getItem('larecipeSidebar') == null) {
                localStorage.setItem('larecipeSidebar', !! 1);
            }
        </script>

        <script src="../../vendor/binarytorch/larecipe/assets/js/app.js"></script>

        <script>
            window.LaRecipe = new CreateLarecipe(config)
        </script>

        <!-- Google Analytics -->
                <!-- /Google Analytics -->

        
        <script>
            LaRecipe.run()
        </script>
    </body>
</html>
