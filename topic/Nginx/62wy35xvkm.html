<!doctype html>
<html>
    <head>
        <!-- META Tags -->
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>Nginx 负载均衡配置 | 风中的木偶</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <!-- SEO -->
        <meta name="author" content="风中的木偶">
        <meta name="description" content="">
        <meta name="keywords" content="木偶笔记,个人技术博客,IT技术笔记,博客,个人网站,风中的木偶,木偶">
        <meta name="twitter:card" value="summary">
                                                                <meta property="og:title" content="风中的木偶个人博客" />
                                                                <meta property="og:type" content="article" />
                                                                <meta property="og:url" content="https://wangmaolin.net" />
                                                                                            
        <!-- CSS -->
        <link rel="stylesheet" href="../../vendor/binarytorch/larecipe/assets/css/app.css">

        
        <!-- FontAwesome -->
        <link rel="stylesheet" href="../../vendor/binarytorch/larecipe/assets/css/font-awesome.css">
                    <link rel="stylesheet" href="../../vendor/binarytorch/larecipe/assets/css/font-awesome-v4-shims.css">
        
        <!-- Dynamic Colors -->
        <style>
    :root {
        --primary: #787AF6;
        --secondary: #2b9cf2;
    }

    :not(pre)>code[class*=language-], pre[class*=language-] {
        border-top: 3px solid #787AF6;
    }
    
    .bg-gradient-primary {
        background: linear-gradient(87deg, #787AF6 0, #2b9cf2 100%) !important;
    }

    [v-cloak] > * { 
        display: none; 
    }
    
    [v-cloak]::before { 
        content: " ";
        position: absolute;
        width: 100%;
        height: 100%;
        background-color: #F2F6FA;
    }
</style>
        
    </head>
    <body>
        <div id="app" v-cloak>
            <div class="fixed pin-t pin-x z-40">
    <div class="bg-gradient-primary text-white h-1"></div>

    <nav class="flex items-center justify-between text-black bg-navbar shadow-xs h-16">
        <div class="flex items-center flex-no-shrink">
            <a href="../../index.html" class="flex items-center flex-no-shrink text-black mx-4">
                
                <p class="inline-block font-semibold mx-1 text-grey-dark">
                    风中的木偶
                </p>
            </a>

            <div class="switch">
                <input type="checkbox" name="1" id="1" v-model="sidebar" class="switch-checkbox"/>
                <label class="switch-label" for="1"></label>
            </div>
        </div>

        <div class="hidden lg:flex items-center justify-end pr-4">
            <div class="relative">
                <form action="https://wangmaolin.net/search" onsubmit="return validateForm()" class="form-search">
                    <input id="search-input" name="q" type="text" placeholder="Search" class="bg-gray-100 appearance-none border-2 border-gray-200 rounded py-2 px-4
         text-gray-800 leading-tight focus:outline-none focus:bg-white focus:border-gray-500">
                </form>
            </div>
        </div>

        <div class="block mx-4 flex items-center">
                        
            
            
            
            

            
            <larecipe-dropdown>
                <larecipe-button type="primary" class="flex">
                    Nginx <i class="mx-1 fa fa-angle-down"></i>
                </larecipe-button>

                <template slot="list">
                    <ul class="list-reset" style="height: 800px;width: 200px">
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../AI/overview.html">AI</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../APP/overview.html">APP</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../CSS/overview.html">CSS</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Docker/overview.html">Docker</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../ELK/overview.html">ELK</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Git/overview.html">Git</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Go语言/overview.html">Go语言</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Laravel/overview.html">Laravel</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Linux/overview.html">Linux</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Linux&#32;服务器配置/overview.html">Linux 服务器配置</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Mac/overview.html">Mac</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../MongoDB/overview.html">MongoDB</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Mqtt/overview.html">Mqtt</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../MySQL/overview.html">MySQL</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="overview.html">Nginx</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../PHP/overview.html">PHP</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Protobuf/overview.html">Protobuf</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Python/overview.html">Python</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../SEO/overview.html">SEO</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Vue&#32;教程/overview.html">Vue 教程</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Windows/overview.html">Windows</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../一无所有到财富自由/overview.html">一无所有到财富自由</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../云服务/overview.html">云服务</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../产品/overview.html">产品</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../元宇宙/overview.html">元宇宙</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../前端/overview.html">前端</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../合伙的本质/overview.html">合伙的本质</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../商业/overview.html">商业</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../大数据/overview.html">大数据</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../天机38局/overview.html">天机38局</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../开源项目/overview.html">开源项目</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../微信/overview.html">微信</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../控糖革命/overview.html">控糖革命</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../搜索/overview.html">搜索</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../支付/overview.html">支付</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../智慧人生/overview.html">智慧人生</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../架构/overview.html">架构</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../算法/overview.html">算法</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../缓存/overview.html">缓存</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../网络/overview.html">网络</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../自媒体/overview.html">自媒体</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../菜谱/overview.html">菜谱</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../设计模式/overview.html">设计模式</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../资源/overview.html">资源</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../软件工具/overview.html">软件工具</a>
                            </li>
                                            </ul>
                </template>
            </larecipe-dropdown>
            

                    </div>
    </nav>
</div>

            
            <div>
	<div class="sidebar" :class="[{'is-hidden': ! sidebar}]">
    <ul>
<li>
<h2>Nginx</h2>
<ul>
<li id="blog28"><a href="jenyd5o97d.html#blog28">Nginx 如何防止域名权重被分散?</a>
<li id="blog62"><a href="lgwyllny3q.html#blog62">Nginx 拦截打点与输出配置</a>
<li id="blog64"><a href="od6vrxev3g.html#blog64">nginx 请求日志格式 log_format 配置</a>
<li id="blog140"><a href="nq5vr9qv7p.html#blog140">Nginx server<em>name </em>;  的理解</a>
<li id="blog286"><a href="lgwylwkv3q.html#blog286">nginx如何防止域名权重被分散?</a>
<li id="blog294"><a href="71xyj10yd9.html#blog294">Nginx 配置子目录项目</a>
<li id="blog303"><a href="mx5e615v0r.html#blog303">启用nginx status状态页详解</a>
<li id="blog305"><a href="n2oeglwy73.html#blog305">Nginx 配置文件说明</a>
<li id="blog306"><a href="7ndvd0weo2.html#blog306">Nginx 禁止ip直接访问或任意域名访问</a>
<li id="blog309"><a href="n3xyq1lvmq.html#blog309">Nginx 日志分析常用命令</a>
<li id="blog310"><a href="54lvo8oe6z.html#blog310">正向代理与反向代理的理解</a>
<li id="blog328"><a href="rpnv3pwywm.html#blog328">Nginx 工作原理、进程模型</a>
</ul>
</li>
<li>
<h2>安全</h2>
<ul>
<li id="blog53"><a href="15dve4k94x.html#blog53">nginx 配置 auth_basic 登录认证的方法</a>
<li id="blog63"><a href="ekpv1mkv8w.html#blog63">Nginx 安全相关配置</a>
<li id="blog70"><a href="j3oyjm8yp5.html#blog70">Nginx 防盗链配置</a>
<li id="blog131"><a href="wkl9n0wvz4.html#blog131">nginx 杜绝 HTTP 伪请求头攻击</a>
<li id="blog293"><a href="1ndvm1nv3j.html#blog293">nginx+php使用open_basedir限制站点目录防止跨站</a>
<li id="blog304"><a href="jenyd0nv7d.html#blog304">Nginx 查看高频访问 IP，并封禁 IP 详解</a>
</ul>
</li>
<li>
<h2>负载均衡</h2>
<ul>
<li id="blog174"><a href="62wy35xvkm.html#blog174">Nginx 负载均衡配置</a>
</ul>
</li>
</ul>
</div>

<style>
    #cnzz_stat_icon_1280630928
    {
        display: none;
    }
</style>

<script src="../../vendor/binarytorch/larecipe/assets/js/jquery.min.js"></script>
<script src="../../modules/blog/js/detail.js"></script>

<script type="text/javascript">
    $(function () {
        var cid = '62wy35xvkm.html';
        if (!checkView(cid)) {
            $.get('https://wangmaolin.net/api/blog/addView/article/62wy35xvkm.html', function (data, status) {
                addView('62wy35xvkm.html')
            });
        }
    });
</script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?7c12b9716af39eb368cff4a19aa89393";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7125202304422722"
     crossorigin="anonymous"></script>
	
	<div class="documentation is-dark" :class="{'expanded': ! sidebar}">
		<h1>Nginx 负载均衡配置</h1><ul>
<li><a href="62wy35xvkm.html#dfd68c447b4c8e6bf6657877177d0636">配置实例</a>
<ul>
<li><a href="62wy35xvkm.html#72c7d6dc4057125f2d973a05ae543906">测试环境</a></li>
<li><a href="62wy35xvkm.html#cda3bbd75d0006896c8dfbd93faf885f">部署策略</a></li>
<li><a href="62wy35xvkm.html#1ceb5ba71e02106cb9d7dd107420626c">A服务器配置</a></li>
<li><a href="62wy35xvkm.html#aded55174d986202aded39b50c558665">B 服务器配置</a></li>
</ul></li>
<li><a href="62wy35xvkm.html#f515195aa155e01711ede5439a569d71">负载均衡策略</a>
<ul>
<li><a href="62wy35xvkm.html#fe4508e8996aadfc3ac2c59fd5442744">轮询</a></li>
<li><a href="62wy35xvkm.html#bef1ea04f55ee366c781c5f8facb5f2b">最少连接</a></li>
<li><a href="62wy35xvkm.html#4aac559105a13e2e8540938f8ce21e1e">权重</a></li>
<li><a href="62wy35xvkm.html#fe9f8aa729cbeb38bfb0b675747e8296">ip_hash</a></li>
</ul></li>
<li><a href="62wy35xvkm.html#80f5f839af67150678faa95ec5c9b4b9">如何实现 session 共享：</a>
<ul>
<li><a href="62wy35xvkm.html#1663f1429cbba3b319fabd976822ec48">不使用session，换作cookie | token</a></li>
<li><a href="62wy35xvkm.html#944a4e1e8c6a212d70fe1f7f31afb0c0">应用服务器自行实现共享</a></li>
<li><a href="62wy35xvkm.html#fe9f8aa729cbeb38bfb0b675747e8296">ip_hash</a></li>
</ul></li>
</ul><h2 id="dfd68c447b4c8e6bf6657877177d0636">配置实例</h2>
<h3 id="72c7d6dc4057125f2d973a05ae543906">测试环境</h3>
<p>域名：api.test.com<br />
服务器：Ubuntu 20.04.3 、  nginx/1.20.1</p>
<p>A服务器：172.21.181.19 （内网ip）</p>
<p>B服务器：172.21.181.1 （内网ip）</p>
<h3 id="cda3bbd75d0006896c8dfbd93faf885f">部署策略</h3>
<p>用A服务器作为主服务器负责分发请求，A、B 服务器用来处理最终请求</p>
<h3 id="1ceb5ba71e02106cb9d7dd107420626c">A服务器配置</h3>
<pre><code class="language-nginx">
# 负载均衡配置
upstream apiServer{
    server  172.21.181.19:18081 weight=2;  # 对应应用服务器server_name 172.21.181.19 , 端口 18081
    server 172.21.181.1:18081 weight=1;
    server 172.21.181.2:18081  down;

   // weight 权重，值越大，则被访问的概率越大
   // down 表示当前服务器不参与负载均衡，也就是说不会被访问到
   // max_fails ：允许请求失败的次数默认为1.当超过最大次数时，返回proxy_next_upstream 模块定义的错误
   // fail_timeout:max_fails 次失败后，暂停的时间。
   // backup： 其它所有的非backup机器down或者忙的时候，请求backup机器。所以这台机器压力会最轻。
}

# 负载均衡请求入口, 接收、分发请求

server
{

        listen 80; #  负载均衡入口 listen 对应外部访问的端口
        server_name api.test.com ; # 负载均衡入口server_name 对应外部访问的域名
        location / {
                proxy_pass   http://apiServer;
                proxy_set_header        Host    $host; # 这是必要设置，传递域名。
                proxy_set_header        X-Real-IP       $remote_addr;
                proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;  # 即将后面变量赋值给前面字段，代理将此字段添加到http头部
        }

}

# A服务器自身也用来处理请求

server
    {
        listen 18081;
        server_name 172.21.181.19;
        index index.html index.htm index.php default.html default.htm default.php;
        root  /alidata/www/api/current/public;

        location / {
                if (!-e $request_filename) {
                    rewrite ^(.*)$ /index.php?s=/$1 last;
                    break;
                }
        }   

        #error_page   404   /404.html;

        # Deny access to PHP files in specific directory
        #location ~ /(wp-content|uploads|wp-includes|images)/.*\.php$ { deny all; }

        location ~ [^/]\.php(/|$)
        {
            try_files $uri =404;
            fastcgi_pass  unix:/tmp/php-cgi.sock;
            fastcgi_index index.php;
            include fastcgi.conf;
        }

        location ~ .*\.(gif|jpg|jpeg|png|bmp|swf)$
        {
            expires      30d;
        }

        location ~ .*\.(js|css)?$
        {
            expires      12h;
        }

        location ~ /.well-known {
            allow all;
        }

        location ~ .*\.(sql)?$
        {
            return 404;
        }

        location ~ /\.
        {
            deny all;
        }

        access_log  /alidata/log/nginx/api.test.com.log main;
        error_log  /alidata/log/nginx/nginx_error.log;
    }</code></pre>
<h3 id="aded55174d986202aded39b50c558665">B 服务器配置</h3>
<pre><code class="language-nginx">server
    {
        listen 18081;
        server_name api.test.com;
        index index.html index.htm index.php default.html default.htm default.php;
        root  /alidata/www/api/current/public;

        location / {
                if (!-e $request_filename) {
                    rewrite ^(.*)$ /index.php?s=/$1 last;
                    break;
                }
        }

        #error_page   404   /404.html;

        # Deny access to PHP files in specific directory
        #location ~ /(wp-content|uploads|wp-includes|images)/.*\.php$ { deny all; }

            location ~ [^/]\.php(/|$)
        {
            try_files $uri =404;
            fastcgi_pass  unix:/tmp/php-cgi.sock;
            fastcgi_index index.php;
            include fastcgi.conf;
        }

        location ~ .*\.(gif|jpg|jpeg|png|bmp|swf)$
        {
            expires      30d;
        }

        location ~ .*\.(js|css)?$
        {
            expires      12h;
        }

        location ~ /.well-known {
            allow all;
        }
        location ~ .*\.(sql)?$
        {
            return 404;
        }

        location ~ /\.
        {
            deny all;
        }

        access_log  /alidata/log/nginx/api.test.com.log main;
        error_log  /alidata/log/nginx/nginx_error.log;
    }</code></pre>
<p>重启2台服务器的 nginx 服务</p>
<p>做完上面的设置，简单的nginx负载均衡就算是配置完成了。可通过在A、B 服务器同路径下放不同内容，不断刷新请求会展示的内容的不同来验证负载均衡是否配置成功。</p>
<blockquote>
<p>对于一台服务器即作为负载均衡的主服务器，又作为应用服务器时要注意不要将请求分发到了请求入口的server,  造成死循环,此时会导致报错“400 Bad Request Request Header Or Cookie Too Large”</p>
</blockquote>
<h2 id="f515195aa155e01711ede5439a569d71">负载均衡策略</h2>
<h3 id="fe4508e8996aadfc3ac2c59fd5442744">轮询</h3>
<p>这是默认的策略，把每个请求逐一分配到不同的server，如果分配到的server不可用，则分配到下一个，直到可用</p>
<pre><code class="language-nginx">upstream test.cc {
    server 192.168.8.143;
    server 192.168.8.144;
}</code></pre>
<h3 id="bef1ea04f55ee366c781c5f8facb5f2b">最少连接</h3>
<p>把请求分配到连接数最少的server</p>
<pre><code class="language-nginx">upstream test.cc {
    least_conn;
    server 192.168.8.143;
    server 192.168.8.144;
}</code></pre>
<h3 id="4aac559105a13e2e8540938f8ce21e1e">权重</h3>
<p>weight默认值为1，值越大则代表被访问的几率越大，如下配置，144的访问数量是143的2倍</p>
<pre><code class="language-nginx">upstream test.cc {
    server 192.168.8.143 weight=1;
    server 192.168.8.144 weight=2;
}</code></pre>
<h3 id="fe9f8aa729cbeb38bfb0b675747e8296">ip_hash</h3>
<p>根据访问客户端ip的hash值分配，这样同一客户端的请求都会被分配到同一个server上，如果牵扯到服务器本地存储 session 的问题，用这个是最好的选择</p>
<pre><code class="language-nginx">upstream test.cc {
    ip_hash;
    server 192.168.8.143;
    server 192.168.8.144;
}</code></pre>
<p>Nginx 支持多组的负载均衡,可以配置多个upstream 来服务于不同的Server.</p>
<h2 id="80f5f839af67150678faa95ec5c9b4b9">如何实现 session 共享：</h2>
<h3 id="1663f1429cbba3b319fabd976822ec48">不使用session，换作cookie | token</h3>
<p>能把session改成cookie，就能避开session的一些弊端，在从前看的一本J2EE的书上，也指明在集群系统中不能用session，否则惹出祸端来就不好办。</p>
<p>如果系统不复杂，就优先考虑能否将session去掉，改动起来非常麻烦的话，再用下面的办法。</p>
<p>还可以像jwt那样用token,通过解密token关联用户</p>
<h3 id="944a4e1e8c6a212d70fe1f7f31afb0c0">应用服务器自行实现共享</h3>
<p>asp.net可以用数据库或memcached来保存session，从而在asp.net本身建立了一个session集群，用这样的方式可以令 session保证稳定，即使某个节点有故障，session也不会丢失，适用于较为严格但请求量不高的场合。但是它的效率是不会很高的，不适用于对效率 要求高的场合。</p>
<p>以上两个办法都跟nginx没什么关系，下面来说说用nginx该如何处理：</p>
<h3 id="fe9f8aa729cbeb38bfb0b675747e8296">ip_hash</h3>
<p>nginx中的ip_hash技术能够将某个ip的请求定向到同一台后端，这样一来这个ip下的某个客户端和某个后端就能建立起稳固的session，ip_hash是在upstream配置中定义的：</p>
<pre><code class="language-nginx">upstream backend {
server 127.0.0.1:8080 ;
server 127.0.0.1:9090 ;
ip_hash;
}</code></pre>
<p>ip_hash是容易理解的，但是因为仅仅能用ip这个因子来分配后端，因此ip_hash是有缺陷的，不能在一些情况下使用：</p>
<ul>
<li>nginx不是最前端的服务器。</li>
</ul>
<p>ip_hash要求nginx一定是最前端的服务器，否则nginx得不到正确ip，就不能根据ip作hash。</p>
<p>譬如使用的是squid为最前端，那么nginx取ip时只能得到squid的服务器ip地址，用这个地址来作分流是肯定错乱的。</p>
<ul>
<li>nginx的后端还有其它方式的负载均衡。    </li>
</ul>
<p>假如nginx后端又有其它负载均衡，将请求又通过另外的方式分流了，那么某个客户端的请求肯定不能定位到同一台session应用服务器上。这么算起来，nginx后端只能直接指向应用服务器，</p>
<p>或者再搭一个squid，然后指向应用服务器。最好的办法是用location作一次分流，</p>
<p>将需要session的部分请求通过ip_hash分流，剩下的走其它后端去。</p>
<p><a href="https://nginx.org/en/docs/stream/ngx_stream_upstream_module.html">Nginx 负载均衡官方文档</a></p><h4 style="text-align:left;line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont, Helvetica Neue, PingFang SC, Hiragino Sans GB , Microsoft YaHei UI , Microsoft YaHei ,Arial,sans-serif;font-size:14px;font-weight:bold;margin:2em 8px 0.5em;color:rgba(250, 81, 81, 1)">引用链接</h4><p style="text-align:left;line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont, Helvetica Neue, PingFang SC, Hiragino Sans GB , Microsoft YaHei UI , Microsoft YaHei ,Arial,sans-serif;font-size:80%;margin:0.5em 8px;color:#3f3f3f"><code style="font-size: 90%; opacity: 0.6;">[1]</code> Nginx 负载均衡官方文档: <i><a href="https://nginx.org/en/docs/stream/ngx_stream_upstream_module.html" target="_blank">https://nginx.org/en/docs/stream/ngx_stream_upstream_module.html</a></i><br></p>
			</div>
</div>

            <larecipe-back-to-top></larecipe-back-to-top>
        </div>


        <script>
            window.config = [];
        </script>

        <script type="text/javascript">
            if(localStorage.getItem('larecipeSidebar') == null) {
                localStorage.setItem('larecipeSidebar', !! 1);
            }
        </script>

        <script src="../../vendor/binarytorch/larecipe/assets/js/app.js"></script>

        <script>
            window.LaRecipe = new CreateLarecipe(config)
        </script>

        <!-- Google Analytics -->
                <!-- /Google Analytics -->

        
        <script>
            LaRecipe.run()
        </script>
    </body>
</html>
