<!doctype html>
<html>
    <head>
        <!-- META Tags -->
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>Linux日志切割工具logrotate 配置 | 风中的木偶</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <!-- SEO -->
        <meta name="author" content="风中的木偶">
        <meta name="description" content="">
        <meta name="keywords" content="木偶笔记,个人技术博客,IT技术笔记,博客,个人网站,风中的木偶,木偶">
        <meta name="twitter:card" value="summary">
                    <link rel="canonical" href="../Linux/kq1ez4qyrl.html" />
                                                                <meta property="og:title" content="风中的木偶个人博客" />
                                                                <meta property="og:type" content="article" />
                                                                <meta property="og:url" content="https://wangmaolin.net" />
                                                                                            
        <!-- CSS -->
        <link rel="stylesheet" href="../../vendor/binarytorch/larecipe/assets/css/app.css">

        
        <!-- FontAwesome -->
        <link rel="stylesheet" href="../../vendor/binarytorch/larecipe/assets/css/font-awesome.css">
                    <link rel="stylesheet" href="../../vendor/binarytorch/larecipe/assets/css/font-awesome-v4-shims.css">
        
        <!-- Dynamic Colors -->
        <style>
    :root {
        --primary: #787AF6;
        --secondary: #2b9cf2;
    }

    :not(pre)>code[class*=language-], pre[class*=language-] {
        border-top: 3px solid #787AF6;
    }
    
    .bg-gradient-primary {
        background: linear-gradient(87deg, #787AF6 0, #2b9cf2 100%) !important;
    }

    [v-cloak] > * { 
        display: none; 
    }
    
    [v-cloak]::before { 
        content: " ";
        position: absolute;
        width: 100%;
        height: 100%;
        background-color: #F2F6FA;
    }
</style>
        <!-- CSRF Token -->
        <meta name="csrf-token" content="q3OlzookkFVI4TNMUSe76mfkfY1CVk02GnTM2CX7">

        
    </head>
    <body>
        <div id="app" v-cloak>
            <div class="fixed pin-t pin-x z-40">
    <div class="bg-gradient-primary text-white h-1"></div>

    <nav class="flex items-center justify-between text-black bg-navbar shadow-xs h-16">
        <div class="flex items-center flex-no-shrink">
            <a href="../../index.html" class="flex items-center flex-no-shrink text-black mx-4">
                
                <p class="inline-block font-semibold mx-1 text-grey-dark">
                    风中的木偶
                </p>
            </a>

            <div class="switch">
                <input type="checkbox" name="1" id="1" v-model="sidebar" class="switch-checkbox"/>
                <label class="switch-label" for="1"></label>
            </div>
        </div>

        <div class="hidden lg:flex items-center justify-end pr-4">
            <div class="relative">
                <form action="https://wangmaolin.net/search" onsubmit="return validateForm()" class="form-search">
                    <input id="search-input" name="q" type="text" placeholder="Search" class="bg-gray-100 appearance-none border-2 border-gray-200 rounded py-2 px-4
         text-gray-800 leading-tight focus:outline-none focus:bg-white focus:border-gray-500">
                </form>
            </div>
        </div>

        <div class="block mx-4 flex items-center">
                        
            
            
            
            

            
            <larecipe-dropdown>
                <larecipe-button type="primary" class="flex">
                    Linux 服务器配置 <i class="mx-1 fa fa-angle-down"></i>
                </larecipe-button>

                <template slot="list">
                    <ul class="list-reset" style="height: 800px;width: 200px">
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../AI/overview.html">AI</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../APP/overview.html">APP</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../CSS/overview.html">CSS</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Docker/overview.html">Docker</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../ELK/overview.html">ELK</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Git/overview.html">Git</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Go语言/overview.html">Go语言</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Laravel/overview.html">Laravel</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Linux/overview.html">Linux</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="overview.html">Linux 服务器配置</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Mac/overview.html">Mac</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../MongoDB/overview.html">MongoDB</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Mqtt/overview.html">Mqtt</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../MySQL/overview.html">MySQL</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Nginx/overview.html">Nginx</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../PHP/overview.html">PHP</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Protobuf/overview.html">Protobuf</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Python/overview.html">Python</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../SEO/overview.html">SEO</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Vue&#32;教程/overview.html">Vue 教程</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Windows/overview.html">Windows</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../一无所有到财富自由/overview.html">一无所有到财富自由</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../云服务/overview.html">云服务</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../产品/overview.html">产品</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../元宇宙/overview.html">元宇宙</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../前端/overview.html">前端</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../合伙的本质/overview.html">合伙的本质</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../商业/overview.html">商业</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../大数据/overview.html">大数据</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../天机38局/overview.html">天机38局</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../开源项目/overview.html">开源项目</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../微信/overview.html">微信</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../控糖革命/overview.html">控糖革命</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../搜索/overview.html">搜索</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../支付/overview.html">支付</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../智慧人生/overview.html">智慧人生</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../架构/overview.html">架构</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../游戏开发/overview.html">游戏开发</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../算法/overview.html">算法</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../缓存/overview.html">缓存</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../网络/overview.html">网络</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../自媒体/overview.html">自媒体</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../菜谱/overview.html">菜谱</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../设计模式/overview.html">设计模式</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../资源/overview.html">资源</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../软件工具/overview.html">软件工具</a>
                            </li>
                                            </ul>
                </template>
            </larecipe-dropdown>
            

                    </div>
    </nav>
</div>

            
            <div>
	<div class="sidebar" :class="[{'is-hidden': ! sidebar}]">
    <ul>
<li>
<h2>新购服务器配置</h2>
<ul>
<li id="blog161"><a href="4oxy7n6e98.html#blog161">ubuntu 切换 sh 为 bash</a>
<li id="blog19"><a href="5m892ov01p.html#blog19">新增用户&amp;赋予 sudo 权限</a>
<li id="blog5"><a href="15dvekv4xj.html#blog5">创建自定义命令</a>
<li id="blog21"><a href="qk2vmoep0m.html#blog21">配置公私钥登录,禁止密码登录</a>
<li id="blog20"><a href="jrqvwly8pn.html#blog20">配置指定命令 sudo 免密码使用</a>
<li id="blog56"><a href="7okv5gne1n.html#blog56">修改 SSH 连接的端口</a>
<li id="blog55"><a href="m0wek8xep9.html#blog55">SSH 设置保持连接方法</a>
<li id="blog54"><a href="7ndvdn2yo2.html#blog54">修改系统 hostname</a>
<li id="blog53"><a href="15dve4k94x.html#blog53">nginx 配置 auth_basic 登录认证</a>
<li id="blog22"><a href="j3oyj89p57.html#blog22">iptables 封禁 ip 方法</a>
<li id="blog189"><a href="02ky02xvz8.html#blog189">Linux 服务器的基本安全配置</a>
</ul>
</li>
<li>
<h2>Lnmp 相关配置</h2>
<ul>
<li id="blog170"><a href="71xyjlmvd9.html#blog170">Lnmp 环境配置</a>
<li id="blog172"><a href="de296j6vq7.html#blog172">MySql 日志配置</a>
<li id="blog53"><a href="15dve4k94x.html#blog53">nginx 配置 auth_basic 登录认证</a>
<li id="blog64"><a href="od6vrxev3g.html#blog64">nginx 日志格式 log_format 配置</a>
<li id="blog101"><a href="kq1ez4qyrl.html#blog101">Linux日志切割工具logrotate 配置</a>
<li id="blog117"><a href="02ky0gx9z8.html#blog117">Redis 日志配置</a>
<li id="blog119"><a href="5m89225901.html#blog119">redis 监听执行日志</a>
<li id="blog171"><a href="wjkv8qnv62.html#blog171">php-fpm.conf 配置说明</a>
</ul>
</li>
</ul>
</div>

<style>
    #cnzz_stat_icon_1280630928
    {
        display: none;
    }
</style>

<script src="../../vendor/binarytorch/larecipe/assets/js/jquery.min.js"></script>
<script src="../../modules/blog/js/detail.js"></script>

<script type="text/javascript">
    $(function () {
        var cid = 'kq1ez4qyrl.html';
        if (!checkView(cid)) {
            $.get('https://wangmaolin.net/api/blog/addView/article/kq1ez4qyrl.html', function (data, status) {
                addView('kq1ez4qyrl.html')
            });
        }
    });
</script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?7c12b9716af39eb368cff4a19aa89393";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7125202304422722"
     crossorigin="anonymous"></script>
	
	<div class="documentation is-dark" :class="{'expanded': ! sidebar}">
		<h1>Linux日志切割工具logrotate 配置</h1><ul>
<li><a href="kq1ez4qyrl.html#411a8eea3b7e481d7a0f2927c19b11bb">以php和nginx 为例：</a></li>
<li><a href="kq1ez4qyrl.html#5a3b63051942fc958da714c7ff33ca93">配置完成后测试：</a></li>
<li><a href="kq1ez4qyrl.html#ce99c41d8d21775d2577ac24547299c2">配置crontab  定时执行</a></li>
<li><a href="kq1ez4qyrl.html#d034ff812dae5e2536e5ff023336cebd">常用参数说明</a></li>
<li><a href="kq1ez4qyrl.html#0727b06c1f8933393349d54b4c334304">Logrotate日志切割报错  文件不再同一个用户组下</a></li>
</ul><p>logrotate 可以用于项目中生成的日志文件切割压缩归档，防止单个日志文件特别大、防止日志文件占用大量磁盘空间。如可以在每天凌晨将上一天生成的日志压缩归档，并检查文件数，自动删除比较老的文件</p>
<h3 id="411a8eea3b7e481d7a0f2927c19b11bb">以php和nginx 为例：</h3>
<pre><code class="language-bash">cd /etc/logrotate.d

vim php

/alidata/log/php/*.log {
        daily
        rotate 30
        dateext
        create
        compress
        sharedscripts
        copytruncate

}

vim nginx

/alidata/log/nginx/access/*/*.log {
        daily
        rotate 30
        dateext
        create
        compress
        sharedscripts
        copytruncate

}

# 或统一配置
/alidata/log/*/*.log {
        daily
        rotate 30
        dateext
        create
        compress
        sharedscripts
        copytruncate
}</code></pre>
<h3 id="5a3b63051942fc958da714c7ff33ca93">配置完成后测试：</h3>
<p>强制执行：</p>
<pre><code class="language-bash">sudo /usr/sbin/logrotate -f /etc/logrotate.conf</code></pre>
<pre><code class="   language-php">若某文件logrotate失败，可以  sudo /usr/sbin/logrotate  -f 单独的配置文件 -v 查看错误信息</code></pre>
<p>强制以调试模式执行</p>
<pre><code class="language-bash">sudo /usr/sbin/logrotate -d -f /etc/logrotate.conf</code></pre>
<p>注意：若配置好后强制执行但新的日志一直未轮转，可以过2天再看看，可能是当天已经执行过单当时未成功，但有了纪录，导致当天不再轮转了。</p>
<h3 id="ce99c41d8d21775d2577ac24547299c2">配置crontab  定时执行</h3>
<p>注意是root用户下</p>
<pre><code class="language-crontab">2 0 * * * /etc/cron.daily/logrotate</code></pre>
<p>重启crontab</p>
<pre><code class="language-bash">sudo service cron restart

# centos
sudo service crond restart</code></pre>
<h3 id="d034ff812dae5e2536e5ff023336cebd">常用参数说明</h3>
<pre><code class="language-ini">常用参数
su wml wml             

compress                     通过gzip 压缩转储以后的日志

nocompress                   不做gzip压缩处理

copytruncate                 用于还在打开中的日志文件，把当前日志备份并截断；是先拷贝再清空的方式，拷贝和清空之间有一个时间差，可能会丢失部分日志数据。

nocopytruncate               备份日志文件不过不截断

create mode owner group      轮转时指定创建新文件的属性，如create 0777 nobody nobody

nocreate                     不建立新的日志文件

delaycompress                和compress 一起使用时，转储的日志文件到下一次转储时才压缩

nodelaycompress              覆盖 delaycompress 选项，转储同时压缩。

missingok                    如果日志丢失，不报错继续滚动下一个日志

errors address               转储时的错误信息发送到指定的Email 地址

ifempty                      即使日志文件为空文件也做轮转，这个是logrotate的缺省选项。

notifempty                   当日志文件为空时，不进行轮转

mail address                 把转储的日志文件发送到指定的E-mail 地址

nomail                       转储时不发送日志文件

olddir directory             转储后的日志文件放入指定的目录，必须和当前日志文件在同一个文件系统

noolddir                     转储后的日志文件和当前日志文件放在同一个目录下

sharedscripts                运行postrotate脚本，作用是在所有日志都轮转后统一执行一次脚本。如果没有配置这个，那么每个日志轮转后都会执行一次脚本

prerotate             在logrotate转储之前需要执行的指令，例如修改文件的属性等动作；必须独立成行

postrotate            在logrotate转储之后需要执行的指令，例如重新启动 (kill -HUP) 某个服务！必须独立成行

daily                 指定转储周期为每天

weekly                指定转储周期为每周

monthly               指定转储周期为每月

rotate count          指定日志文件删除之前转储的次数，0 指没有备份，5 指保留5 个备份

dateext               使用当期日期作为命名格式

dateformat .%s        配合dateext使用，紧跟在下一行出现，定义文件切割后的文件名，必须配合dateext使用，只支持 %Y %m %d %s 这四个参数

size(或minsize) log-size    当日志文件到达指定的大小时才转储，log-size能指定bytes(缺省)及KB (sizek)或MB(sizem).

当日志文件 &gt;= log-size 的时候就转储。 以下为合法格式：（其他格式的单位大小写没有试过）

size = 5 或 size 5 （&gt;= 5 个字节就转储）

size = 100k 或 size 100k

size = 100M 或 size 100M</code></pre>
<h3 id="0727b06c1f8933393349d54b4c334304">Logrotate日志切割报错  文件不再同一个用户组下</h3>
<p>分割日志时报错：</p>
<pre><code class="   language-php">：error: skipping "/var/log/nginx/test.access.log" because parent
directory has insecure permissions (It's world writable or writable by
group which is not "root") Set "su" directive in config file to tell
logrotate which user/group should be used for rotation.</code></pre>
<p>xx 文件所属用户</p>
<p>添加“su root xx”到/etc/logrotate.d/nginx文件中即可<br />
如下；</p>
<pre><code class="   language-php">/var/log/nginx/*.log {
        su root public
        daily
        missingok
        rotate 52
        compress
        delaycompress
        notifempty
        #ifempty
        create 0640 www-data adm
        sharedscripts
        postrotate
                [ ! -f /var/run/nginx.pid ] || kill -USR1 `cat /var/run/nginx.pid`
        endscript
}</code></pre>
			</div>
</div>

            <larecipe-back-to-top></larecipe-back-to-top>
        </div>


        <script>
            window.config = [];
        </script>

        <script type="text/javascript">
            if(localStorage.getItem('larecipeSidebar') == null) {
                localStorage.setItem('larecipeSidebar', !! 1);
            }
        </script>

        <script src="../../vendor/binarytorch/larecipe/assets/js/app.js"></script>

        <script>
            window.LaRecipe = new CreateLarecipe(config)
        </script>

        <!-- Google Analytics -->
                <!-- /Google Analytics -->

        
        <script>
            LaRecipe.run()
        </script>
    </body>
</html>
