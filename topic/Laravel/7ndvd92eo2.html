<!doctype html>
<html>
    <head>
        <!-- META Tags -->
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>使用 Octane 扩展加速您的 Laravel 项目 | 风中的木偶</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <!-- SEO -->
        <meta name="author" content="风中的木偶">
        <meta name="description" content="">
        <meta name="keywords" content="木偶笔记,个人技术博客,IT技术笔记,博客,个人网站,风中的木偶,木偶">
        <meta name="twitter:card" value="summary">
                                                                <meta property="og:title" content="风中的木偶个人博客" />
                                                                <meta property="og:type" content="article" />
                                                                <meta property="og:url" content="https://wangmaolin.net" />
                                                                                            
        <!-- CSS -->
        <link rel="stylesheet" href="../../vendor/binarytorch/larecipe/assets/css/app.css">

        
        <!-- FontAwesome -->
        <link rel="stylesheet" href="../../vendor/binarytorch/larecipe/assets/css/font-awesome.css">
                    <link rel="stylesheet" href="../../vendor/binarytorch/larecipe/assets/css/font-awesome-v4-shims.css">
        
        <!-- Dynamic Colors -->
        <style>
    :root {
        --primary: #787AF6;
        --secondary: #2b9cf2;
    }

    :not(pre)>code[class*=language-], pre[class*=language-] {
        border-top: 3px solid #787AF6;
    }
    
    .bg-gradient-primary {
        background: linear-gradient(87deg, #787AF6 0, #2b9cf2 100%) !important;
    }

    [v-cloak] > * { 
        display: none; 
    }
    
    [v-cloak]::before { 
        content: " ";
        position: absolute;
        width: 100%;
        height: 100%;
        background-color: #F2F6FA;
    }
</style>
        <!-- CSRF Token -->
        <meta name="csrf-token" content="q3OlzookkFVI4TNMUSe76mfkfY1CVk02GnTM2CX7">

        
    </head>
    <body>
        <div id="app" v-cloak>
            <div class="fixed pin-t pin-x z-40">
    <div class="bg-gradient-primary text-white h-1"></div>

    <nav class="flex items-center justify-between text-black bg-navbar shadow-xs h-16">
        <div class="flex items-center flex-no-shrink">
            <a href="../../index.html" class="flex items-center flex-no-shrink text-black mx-4">
                
                <p class="inline-block font-semibold mx-1 text-grey-dark">
                    风中的木偶
                </p>
            </a>

            <div class="switch">
                <input type="checkbox" name="1" id="1" v-model="sidebar" class="switch-checkbox"/>
                <label class="switch-label" for="1"></label>
            </div>
        </div>

        <div class="hidden lg:flex items-center justify-end pr-4">
            <div class="relative">
                <form action="https://wangmaolin.net/search" onsubmit="return validateForm()" class="form-search">
                    <input id="search-input" name="q" type="text" placeholder="Search" class="bg-gray-100 appearance-none border-2 border-gray-200 rounded py-2 px-4
         text-gray-800 leading-tight focus:outline-none focus:bg-white focus:border-gray-500">
                </form>
            </div>
        </div>

        <div class="block mx-4 flex items-center">
                        
            
            
            
            

            
            <larecipe-dropdown>
                <larecipe-button type="primary" class="flex">
                    Laravel <i class="mx-1 fa fa-angle-down"></i>
                </larecipe-button>

                <template slot="list">
                    <ul class="list-reset" style="height: 800px;width: 200px">
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../AI/overview.html">AI</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../APP/overview.html">APP</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../CSS/overview.html">CSS</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Docker/overview.html">Docker</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../ELK/overview.html">ELK</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Git/overview.html">Git</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Go语言/overview.html">Go语言</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="overview.html">Laravel</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Linux/overview.html">Linux</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Linux&#32;服务器配置/overview.html">Linux 服务器配置</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Mac/overview.html">Mac</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../MongoDB/overview.html">MongoDB</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Mqtt/overview.html">Mqtt</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../MySQL/overview.html">MySQL</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Nginx/overview.html">Nginx</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../PHP/overview.html">PHP</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Protobuf/overview.html">Protobuf</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Python/overview.html">Python</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../SEO/overview.html">SEO</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Vue&#32;教程/overview.html">Vue 教程</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../Windows/overview.html">Windows</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../一无所有到财富自由/overview.html">一无所有到财富自由</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../云服务/overview.html">云服务</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../产品/overview.html">产品</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../元宇宙/overview.html">元宇宙</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../前端/overview.html">前端</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../合伙的本质/overview.html">合伙的本质</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../商业/overview.html">商业</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../大数据/overview.html">大数据</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../天机38局/overview.html">天机38局</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../开源项目/overview.html">开源项目</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../微信/overview.html">微信</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../控糖革命/overview.html">控糖革命</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../搜索/overview.html">搜索</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../支付/overview.html">支付</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../智慧人生/overview.html">智慧人生</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../架构/overview.html">架构</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../游戏开发/overview.html">游戏开发</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../算法/overview.html">算法</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../缓存/overview.html">缓存</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../网络/overview.html">网络</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../自媒体/overview.html">自媒体</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../菜谱/overview.html">菜谱</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../设计模式/overview.html">设计模式</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../资源/overview.html">资源</a>
                            </li>
                                                    <li class="py-2 hover:bg-grey-lightest">
                                <a class="px-6 text-grey-darkest"
                                   href="../软件工具/overview.html">软件工具</a>
                            </li>
                                            </ul>
                </template>
            </larecipe-dropdown>
            

                    </div>
    </nav>
</div>

            
            <div>
	<div class="sidebar" :class="[{'is-hidden': ! sidebar}]">
    <ul>
<li>
<h2>Laravel</h2>
<ul>
<li id="blog1"><a href="nxq9zrvdow.html#blog1">Laravel 请求的生命周期介绍</a>
<li id="blog2"><a href="z64y96y5lg.html#blog2">Laravel blade 模板压缩、加速扩展 renatomarinho/Laravel-page-speed 介绍</a>
<li id="blog7"><a href="m0wekxvp9k.html#blog7">Laravel 生成精美的项目使用文档扩展 overtrue/wisteria</a>
<li id="blog8"><a href="7okv5nv1nw.html#blog8">Laravel 腾讯云 cos 存储扩展</a>
<li id="blog16"><a href="nq5vrgy7p3.html#blog16">如何在 Laravel 中创建自定义辅助函数</a>
<li id="blog17"><a href="1j6y0je2k8.html#blog17">如何在 Laravel 中创建自定义日志文件？</a>
<li id="blog27"><a href="mx5e6dkv0r.html#blog27">使你的 Laravel 项目模块化</a>
<li id="blog77"><a href="n2oegkzv73.html#blog77">Dcat Admin 扩展收集</a>
<li id="blog78"><a href="7ndvd92eo2.html#blog78">使用 Octane 扩展加速您的 Laravel 项目</a>
<li id="blog135"><a href="pwde4ldy6q.html#blog135">Laravel中使用group by报错的问题</a>
<li id="blog152"><a href="rpnv3l0vwm.html#blog152">Laravel 项目加速</a>
<li id="blog156"><a href="7okv521v1n.html#blog156">Laravel 代码提示工具 Laravel IDE Helper 介绍</a>
<li id="blog229"><a href="n2oeg58v73.html#blog229">Laravel 常用扩展收集</a>
<li id="blog322"><a href="71xyjjryd9.html#blog322">Larvale MySQL事务回退、悲观锁</a>
<li id="blog422"><a href="71xyjpxyd9.html#blog422">Laravel octane 使用蓝绿部署方案实现0停机部署</a>
<li id="blog434"><a href="54lvo52e6z.html#blog434">使用 AdapterMan 扩展加速您的 Laravel 项目</a>
</ul>
</li>
<li>
<h2>扩展</h2>
<ul>
<li id="blog7"><a href="m0wekxvp9k.html#blog7">Laravel 生成精美的项目使用文档扩展 overtrue/wisteria</a>
<li id="blog127"><a href="k3dyk0m9l0.html#blog127">Laravel 文件和数据库备份工具 spatie/laravel-backup 介绍</a>
<li id="blog155"><a href="wkl9nxwvz4.html#blog155">Laravel 、 PHP 二维码生成扩展 SimpleSoftwareIO/simple-qrcode</a>
<li id="blog156"><a href="7okv521v1n.html#blog156">Laravel 代码提示工具 Laravel IDE Helper 介绍</a>
<li id="blog158"><a href="4x3vomkym1.html#blog158">使用 Laravel Excel 实现 Excel/CSV 文件导入导出</a>
<li id="blog159"><a href="3qk945gvw1.html#blog159">客户端 User Agent 解析扩展</a>
<li id="blog229"><a href="n2oeg58v73.html#blog229">Laravel 常用扩展收集</a>
</ul>
</li>
<li>
<h2>DcatAdmin</h2>
<ul>
<li id="blog37"><a href="4oxy778y98.html#blog37">DcatAdmin 表格和表单各按钮显示控制方法汇总</a>
<li id="blog49"><a href="kq1ez6kvrl.html#blog49">给 Dcat Admin 框架 Markdown 编辑器添加图片复制粘贴自动上传功能</a>
<li id="blog77"><a href="n2oegkzv73.html#blog77">Dcat Admin 扩展收集</a>
<li id="blog87"><a href="j25v1g6v1n.html#blog87">Dcat Admin 自定义 TinyMce 富文本编辑器设置</a>
<li id="blog88"><a href="nq5vr3gv7p.html#blog88">Dcat Admin 关联模型字段翻译设置</a>
<li id="blog89"><a href="1j6y0dje2k.html#blog89">Dcat Admin 实现 Excel 数据导入</a>
<li id="blog90"><a href="xkdvp9qezo.html#blog90">Dcat Admin 数据表格工具栏添加后台交互按钮</a>
<li id="blog178"><a href="7ndvdjpvo2.html#blog178">Dcat Admin 表格中每行添加异步加载数据表格按钮方法</a>
</ul>
</li>
<li>
<h2>editor.md</h2>
<ul>
<li id="blog49"><a href="kq1ez6kvrl.html#blog49">给 Dcat Admin 框架 Markdown 编辑器添加图片复制粘贴自动上传功能</a>
</ul>
</li>
<li>
<h2>Octane</h2>
<ul>
<li id="blog78"><a href="7ndvd92eo2.html#blog78">使用 Octane 扩展加速您的 Laravel 项目</a>
<li id="blog422"><a href="71xyjpxyd9.html#blog422">Laravel octane 使用蓝绿部署方案实现0停机部署</a>
</ul>
</li>
<li>
<h2>swoole</h2>
<ul>
<li id="blog78"><a href="7ndvd92eo2.html#blog78">使用 Octane 扩展加速您的 Laravel 项目</a>
</ul>
</li>
<li>
<h2>TinyMce</h2>
<ul>
<li id="blog87"><a href="j25v1g6v1n.html#blog87">Dcat Admin 自定义 TinyMce 富文本编辑器设置</a>
</ul>
</li>
<li>
<h2>跨域</h2>
<ul>
<li id="blog130"><a href="7ndvd4pvo2.html#blog130">Lumen 框架解决非简单请求 cors 跨域问题</a>
</ul>
</li>
<li>
<h2>Lumen</h2>
<ul>
<li id="blog130"><a href="7ndvd4pvo2.html#blog130">Lumen 框架解决非简单请求 cors 跨域问题</a>
</ul>
</li>
<li>
<h2>MySQL</h2>
<ul>
<li id="blog135"><a href="pwde4ldy6q.html#blog135">Laravel中使用group by报错的问题</a>
<li id="blog322"><a href="71xyjjryd9.html#blog322">Larvale MySQL事务回退、悲观锁</a>
<li id="blog460"><a href="x569xd8vep.html#blog460">Laravel 动态创建 mysql 数据库表</a>
</ul>
</li>
</ul>
</div>

<style>
    #cnzz_stat_icon_1280630928
    {
        display: none;
    }
</style>

<script src="../../vendor/binarytorch/larecipe/assets/js/jquery.min.js"></script>
<script src="../../modules/blog/js/detail.js"></script>

<script type="text/javascript">
    $(function () {
        var cid = '7ndvd92eo2.html';
        if (!checkView(cid)) {
            $.get('https://wangmaolin.net/api/blog/addView/article/7ndvd92eo2.html', function (data, status) {
                addView('7ndvd92eo2.html')
            });
        }
    });
</script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?7c12b9716af39eb368cff4a19aa89393";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7125202304422722"
     crossorigin="anonymous"></script>
	
	<div class="documentation is-dark" :class="{'expanded': ! sidebar}">
		<h1>使用 Octane 扩展加速您的 Laravel 项目</h1><ul>
<li><a href="7ndvd92eo2.html#0e1bdaee619584ffa3145224e4f00551">Laravel Octane 的组成</a></li>
<li><a href="7ndvd92eo2.html#780aef0ee3cce6bd0b07409e81f03aaf">Octane 简单示列</a>
<ul>
<li><a href="7ndvd92eo2.html#816ae7e5d08c4f62e4d2893101e9aebb">创建一个Laravel项目</a></li>
<li><a href="7ndvd92eo2.html#3c9c1987bf6a6f47209dc95dc8bbfc6a">安装 Laravel Octane 扩展</a></li>
</ul></li>
<li><a href="7ndvd92eo2.html#af7ff4566f808e12e22389a616a323bc">使用 Swoole Server</a>
<ul>
<li><a href="7ndvd92eo2.html#f842f6424e7e670e7af65b13b94721ba">用wrk对服务进行压测结果如下：</a>
<ul>
<li><a href="7ndvd92eo2.html#250531a2132a0cac2a983b35c7acc8bf">Artisan Serve 驱动时结果：</a></li>
<li><a href="7ndvd92eo2.html#687e3e0ca1e71db1c332502ada6abccd">Swoole Server 驱动时结果</a></li>
</ul></li>
</ul></li>
<li><a href="7ndvd92eo2.html#88dc47e61315b33d56ce68fd050fafbf">部署上线</a>
<ul>
<li><a href="7ndvd92eo2.html#30d148b414737035b9730324f252a551">持续交付方法</a></li>
</ul></li>
<li><a href="7ndvd92eo2.html#7275b2fb2cfb9755e2dca470e4f04129">如何使代码更改实时生效</a></li>
<li><a href="7ndvd92eo2.html#c72872a30e7db4a022d8ba054b7ac33f">指定 Worker 进程数和最大处理请求数</a></li>
<li><a href="7ndvd92eo2.html#6aac11bbc51a96e8835d36b260c1f362">其他常用命令</a>
<ul>
<li><a href="7ndvd92eo2.html#1a70a5c0f6ddaf1d4662c7e1d0f258ca">优雅重启 Worker 进程</a></li>
<li><a href="7ndvd92eo2.html#11bc1d33740306772c6ec916ecaae170">服务停止</a></li>
<li><a href="7ndvd92eo2.html#70c85901843d22ce01e30905252101ac">查看服务状态</a></li>
</ul></li>
<li><a href="7ndvd92eo2.html#46bad5103db6286ce93733759cfcc350">Nginx 配置</a></li>
<li><a href="7ndvd92eo2.html#2c96d195245ca5893a174c5154fa7b93">Laravel Octane 是线程安全的吗？</a></li>
<li><a href="7ndvd92eo2.html#def2b0d920796201e57c95783cbcc347">Laravel Octane 工作原理</a></li>
<li><a href="7ndvd92eo2.html#1bbbb204023e59eba03319c7c5848fd1">注意事项</a>
<ul>
<li><a href="7ndvd92eo2.html#64cf0dc3e7fa92e3536eac319cdab7cb">容器注入</a></li>
<li><a href="7ndvd92eo2.html#27db708bcfd0c253b01e08f424d2c62d">请求注入</a></li>
<li><a href="7ndvd92eo2.html#46379fcd70d9617cbbbf26dbdd8d20d6">配置注入</a></li>
<li><a href="7ndvd92eo2.html#e1d7a37ee6cda63c47e487a106d93a42">管理内存泄漏</a></li>
</ul></li>
</ul><p>Laravel 框架一直很优秀，但是他在性能方面却一直为人诟病。框架的 boot 时间可能比业务处理时间还长，并且随着项目第三方 service provider 的增多，其启动速度越来越不受控。而 Laravel Octane 则通过启动 Application 一次，常驻内存的方式来加速我们的应用。接下来我们介绍Laravel Octane 扩展的使用。</p>
<h2 id="0e1bdaee619584ffa3145224e4f00551">Laravel Octane 的组成</h2>
<p>Laravel Octane 内置了两个高性能的应用服务：Swoole 和 RoadRunner</p>
<p>注意 Laravel Octane 需要 PHP8.0 以上版本。</p>
<p>PHP是一种解释语言。这意味着，当PHP脚本运行时，解释器会对每个请求反复解析、编译和执行代码。这会导致CPU资源的浪费和花费额外的时间。</p>
<p>Swoole所做的是将编译后的脚本/容器存储到内存中，以便在接受下一个请求时重用。有了这些功能，你的应用不需要一次又一次地重新编译脚本。</p>
<h2 id="780aef0ee3cce6bd0b07409e81f03aaf">Octane 简单示列</h2>
<p>虽说官方文档已经描述的很详细，不过作者这里还是通过一个简单的示列项目来演示。</p>
<h3 id="816ae7e5d08c4f62e4d2893101e9aebb">创建一个Laravel项目</h3>
<pre><code class="language-bash">➜ laravel new laravel-octane-test

 _                               _
| |                             | |
| |     __ _ _ __ __ ___   _____| |
| |    / _` | '__/ _` \\ \\ / / _ \\ |
| |___| (_| | | | (_| |\\ V /  __/ |
|______\\__,_|_|  \\__,_| \\_/ \\___|_|

Creating a "laravel/laravel" project at "./laravel-octane-test"
Installing laravel/laravel (v8.5.16)
...
Application ready! Build something amazing.</code></pre>
<h3 id="3c9c1987bf6a6f47209dc95dc8bbfc6a">安装 Laravel Octane 扩展</h3>
<pre><code class="language-bash">$ composer require laravel/octane</code></pre>
<p>安装成功后，读者可以直接执行 <code>php artisan octane:install</code> 来安装依赖；Octane 将提示你想使用的 server 类型。</p>
<pre><code class="language-bash">➜ php artisan octane:install

 Which application server you would like to use?:
  [0] roadrunner
  [1] swoole
 &gt;</code></pre>
<p>如果你选择的是 RoadRunner，程序将会自动帮你安装 RoadRunner 所需的依赖；而如果你选择的是 Swoole，你只需要确保你已经手动安装了 PHP swoole 扩展。</p>
<p>建议使用 Swoole，RoadRunner 的使用过程不尽人意，在安装过程中总会出现一些官方文档忽视的错误。下面已 swoole 为例说明</p>
<h2 id="af7ff4566f808e12e22389a616a323bc">使用 Swoole Server</h2>
<p>安装好 PHP swoole 扩展后，无需任何配置就能启动服务。</p>
<p>服务启动命令</p>
<pre><code class="language-bash">php artisan octane:start</code></pre>
<p>默认情况下，Octane 将在端口 8000 上启动服务器，因为您可以通过 <a href="http://localhost:8000">http://localhost:8000</a> 在浏览器中访问您的应用程序。</p>
<p>访问该路由并查看 Laravel 应用程序！ 如果你发出了多个请求，将会看到第一个请求稍微慢一点，因为这是框架启动的地方，而其他请求则明显更快，因为它们可以从内存中使用启动后的框架。</p>
<p><img src="../../storage/markdown/images/2021/12/24/72e19ba5c2c91970c903b100676f321161c5ce5953bf6.png" alt="" /></p>
<h3 id="f842f6424e7e670e7af65b13b94721ba">用wrk对服务进行压测结果如下：</h3>
<h4 id="250531a2132a0cac2a983b35c7acc8bf">Artisan Serve 驱动时结果：</h4>
<p>请求数 23.5 次每秒</p>
<p><img src="../../storage/markdown/images/2021/12/24/9a6f2f8e64e2eeb53111e23c9e0a337f61c5d687a1eaa.png" alt="Artisan Serve 驱动时" /></p>
<h4 id="687e3e0ca1e71db1c332502ada6abccd">Swoole Server 驱动时结果</h4>
<p>请求数可以达到 218.52 次每秒</p>
<p><img src="../../storage/markdown/images/2021/12/24/9e1b04da8f48550c5e770588d69098d561c5d73770294.png" alt="" /></p>
<p>在同样代码、机器配置，网络环境下可以看到，swoole驱动时性能提升了将近10倍</p>
<h2 id="88dc47e61315b33d56ce68fd050fafbf">部署上线</h2>
<p>Laravel Octane 虽然提供了 start 命令用于启动 Server，但该命令只能在前台运行（不支持 -d）；在部署到生产环境时，常见的办法还是利用 Supervisor 来进行进程管理。可参考 如下 Supervisor 配置。</p>
<pre><code class="   language-php">[program:laravel_octane_server]
command =   /usr/local/php/bin/php -d variables_order=EGPCS /www/laravel/artisan octane:start  --port=8001 --max-requests=5000 --workers=4 --task-workers=4
user=www
process_name            = %(program_name)s_%(process_num)s
numprocs                = 1
autostart               = true
autorestart             = true
stdout_logfile          = /alidata/log/supervisor/laravel_do_server_out.log
stdout_logfile_maxbytes = 10MB
stderr_logfile          = /alidata/log/supervisor/laravel_do_server_err.log
stderr_logfile_maxbytes = 10MB
redirect_stderr=true</code></pre>
<h3 id="30d148b414737035b9730324f252a551">持续交付方法</h3>
<p>方法一、使用 octane:reload 命令重新加载服务。</p>
<pre><code class="language-bash">php artisan config:cache  &amp;&amp; php artisan route:cache &amp;&amp; php artisan octane:reload</code></pre>
<p>方法二、通过 supervisorctl 重启服务 </p>
<p>当你更新了 Composer 依赖，如新增了一个第三方包时，你最好在生产环境重启下 Laravel Octane。否则可能会出现如 Class “Godruoyi\Snowflake\Snowflake” not found 的错误。</p>
<pre><code class="language-bash">php artisan config:cache  &amp;&amp; php artisan route:cache &amp;&amp; sudo supervisorctl -c /etx/supervisorctl.conf restart program:laravel_octane_server</code></pre>
<p>通过持续交付部署工具，运行上述命令中的其中一个即可。</p>
<p>要注意 <code>php artisan octane:reload</code> 有时候代码不更新的问题， 可以测试下看看， 但 restart 会导致进程暂时终止，如果此时有大量请求会报 502 , 这个测试下自己权衡。</p>
<h2 id="7275b2fb2cfb9755e2dca470e4f04129">如何使代码更改实时生效</h2>
<p>在启动服务后，如果我们更改了代码，访问时会发现显示并没有发送改变！ 这是因为请求访问的是 Octane 服务内存中的框架（及其所有路由 / 代码）。 因此，为了查看代码更改，需要重启 Octane 服务。 这导致在开发过程中非常麻烦，所以 Octane 提供了一种很好的方式来自动监视代码库的更改并自动重启 Octane 服务。</p>
<p>为了完成这项工作，请确保安装 Chokidar - 基于 NodeJS 的文件监视库：</p>
<pre><code class="language-bash">npm install --save-dev chokidar</code></pre>
<p>然后，您可以在 “watch” 模式下启动 Octane 服务器，如下所示：</p>
<pre><code class="language-bash">php artisan octane:start --watch</code></pre>
<p>现在，下次您对代码库进行更改时，系统会检测到这一点，Octane 将为请求重启工作程序，您可以立即看到您的更改。</p>
<h2 id="c72872a30e7db4a022d8ba054b7ac33f">指定 Worker 进程数和最大处理请求数</h2>
<p>默认情况下，Octane 会根据机器 CPU 的内核数来启动对应数量的请求处理器进程（Worker），你也可以在基于 Octane 启动服务器时通过 --workers 参数手动指定 Worker 数量：</p>
<pre><code class="language-bash">php artisan octane:start --workers=4</code></pre>
<p>如果使用的是Swoole应用程序服务器，则还可以指定要启动的“任务工作者”数量：</p>
<pre><code class="language-bash">php artisan octane:start --workers=4 --task-workers=6</code></pre>
<p>PHP 应用常驻内存带来的另一个问题是内存泄露，你可以通过 --max-request 参数指定一个 Worker 最多能够处理的请求数来解决这个问题：</p>
<pre><code class="language-bash">php artisan octane:start --max-requests=250</code></pre>
<p>当超过这个限制后，Octane 会优雅重启该 Worker。</p>
<h2 id="6aac11bbc51a96e8835d36b260c1f362">其他常用命令</h2>
<h3 id="1a70a5c0f6ddaf1d4662c7e1d0f258ca">优雅重启 Worker 进程</h3>
<p>和 Nginx 类似，你可以通过 roload 指令优雅重启所有 PHP Worker 进程：</p>
<pre><code class="   language-php">php artisan octane:reload</code></pre>
<h3 id="11bc1d33740306772c6ec916ecaae170">服务停止</h3>
<p>您可以使用octane:stopArtisan命令停止Octane服务器：</p>
<pre><code class="language-bash">php artisan octane:stop</code></pre>
<h3 id="70c85901843d22ce01e30905252101ac">查看服务状态</h3>
<pre><code class="language-bash">php artisan octane:status</code></pre>
<h2 id="46bad5103db6286ce93733759cfcc350">Nginx 配置</h2>
<pre><code class="language-nginx">map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

# 负载均衡配置
#upstream api_list{
#    server 127.0.0.1:8020;
#    server 127.0.0.1:8025;
#}

server {
    listen 80;
    listen [::]:80;
    server_name domain.com;
    server_tokens off;
    root /alidata/www/laravel-do/public;

    index index.html index.htm index.php default.html default.htm default.php;

    charset utf-8;

    error_page 404 /index.php;

    location /index.php {
        try_files /not_exists @octane;
    }

    location / {
        try_files $uri $uri/ @octane;
    }

    location = /favicon.ico { access_log off; log_not_found off; }
    location = /robots.txt  { access_log off; log_not_found off; }

    location ~ .*\\.(gif|jpg|jpeg|png|bmp|swf)$
    {
        expires      30d;
    }

    location ~ .*\\.(js|css)?$
    {
        expires      12h;
    }

    location ~ /.well-known {
        allow all;
    }

    location ~ /\\.
    {
        deny all;
    }

    access_log  /alidata/log/nginx/domain.com.log main;
    error_log  /alidata/log/nginx/nginx_error.log;

    location @octane {
        set $suffix "";

        if ($uri = /index.php) {
            set $suffix ?$query_string;
        }

        proxy_http_version 1.1;
        proxy_set_header Host $http_host;
        proxy_set_header Scheme $scheme;
        proxy_set_header SERVER_PORT $server_port;
        proxy_set_header REMOTE_ADDR $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;

        proxy_pass http://127.0.0.1:8000$suffix;

        # 负载均衡配置
        # proxy_pass http://api_list$suffix;
    }
}
</code></pre>
<h2 id="2c96d195245ca5893a174c5154fa7b93">Laravel Octane 是线程安全的吗？</h2>
<p>在回答这个问题之前，我们先来看看 Laravel Octane 的请求处理流程。</p>
<p><img src="../../storage/markdown/images/2021/12/24/4a8e62d4af2a481751cbf06a3d025b9061c5d1b3be471.png" alt="" /></p>
<p>随着 Server 的启动，程序会创建指定数量的 Worker 进程。当请求到来时，会从可用的 Worker 列表中选取一个并交由他处理。每个 Worker 同一时刻只能处理一个请求，在请求处理过程中，对资源（变量 / 静态变量 / 文件句柄 / 链接）的修改并不会存在竞争关系，所以 Laravel Octane 时线程 (进程) 安全的。</p>
<p>这其实和 FPM 模型是一致的，不同的地方在于 FPM 模型在处理完一个请求后，会销毁该请求申请的所有内存；后续请求到来时，依然要执行完整的 PHP 初始化操作（参考 PHP-FPM 启动分析）。而 Laravel Octane 的初始化操作是随着 Worker Boot 进行的，在整个 Worker 的生命周期内，只会进行一次初始操作（程序启动的时候）。后续请求将直接复用原来的资源。如上图，Worker Boot 完成后，将会初始化 Laravel Application Container，而后续的所有请求，都将复用该 App 实例。</p>
<h2 id="def2b0d920796201e57c95783cbcc347">Laravel Octane 工作原理</h2>
<p>Octane 只是一个壳，真正处理请求都是由外部的 Server 处理的。不过 Octane 的设计还是值得一说的。</p>
<p>从源码也可以看出，随着 Worker 的 Boot 完成，Laravel Application 已被成功初始化。</p>
<pre><code class="language-php">// vendor/laravel/octane/src/Worker.php
public function boot(array $initialInstances = []): void
{
    $this-&gt;app = $app = $this-&gt;appFactory-&gt;createApplication(
        array_merge(
            $initialInstances,
            [Client::class =&gt; $this-&gt;client],
        )
    );

    $this-&gt;dispatchEvent($app, new WorkerStarting($app));
}</code></pre>
<p>在处理后续到来的请求时，Octane 通过 <code>clone $this-&gt;app</code> 获取一个沙箱容器。后续的所有操作都是基于这个沙箱容器来进行的，不会影响到原有的 Container。在请求结束后，Octane 会清空沙箱容器并 unset 不再使用的对象。</p>
<pre><code class="language-php">public function handle(Request $request, RequestContext $context): void
{
    CurrentApplication::set($sandbox = clone $this-&gt;app);

    try {
        $response = $sandbox-&gt;make(Kernel::class)-&gt;handle($request); 

    } catch (Throwable $e) {
        $this-&gt;handleWorkerError($e, $sandbox, $request, $context, $responded);
    } finally {
        $sandbox-&gt;flush();

        unset($gateway, $sandbox, $request, $response, $octaneResponse, $output);

        CurrentApplication::set($this-&gt;app);
    }
}</code></pre>
<p>再次注意，由于同一个 Worker 进程同一时刻只能处理一个请求，故这里是不存在竞争的，即使是对 static 变量的修改，也是安全的。</p>
<h2 id="1bbbb204023e59eba03319c7c5848fd1">注意事项</h2>
<p>由于一个 Worker 会处理多个请求，而在同一个 Worker 中，只会在初始化时加载一次 Laravel 应用，后面的请求会复用第一次加载的服务容器（意味着所有服务提供者的 register 和 boot 方法只有第一次加载时会被调用，这就是所谓的「常驻内存」），所以我们在切换到基于 Laravel Octane 驱动 的 HTTP 服务器时，对于服务注入要格外小心，不要将后续会变动的对象以单例模式注入服务容器，也不要让有状态的数据被所有请求共享。</p>
<p>Octane 会在不同请求间自动处理所有官方框架提供功能的状态重置，但是无法重置你自己在业务代码中编写的全局状态，这里我们列举一些常见的容易出问题的几个典型示例，如果你的业务代码目前存在这些问题，需要进行调整。</p>
<h3 id="64cf0dc3e7fa92e3536eac319cdab7cb">容器注入</h3>
<p>不要将服务容器、请求实例或者其他会发生变动的对象以单例模式注入到某个服务的构造函数：</p>
<pre><code class="language-php">use App\\Service;

/**
 * Register any application services.
 *
 * @return void
 */
public function register()
{
    $this-&gt;app-&gt;singleton(Service::class, function ($app) {
        return new Service($app);
    });
}</code></pre>
<p>这会导致后续请求只能解析出初次调用该 register 方法时传入构造函数的对象。要解决这个问题，可以通过普通模式注入或者闭包方式注入：</p>
<pre><code class="language-php">use App\\Service;
use Illuminate\\Container\\Container;

$this-&gt;app-&gt;bind(Service::class, function ($app) {
    return new Service($app);
});

$this-&gt;app-&gt;singleton(Service::class, function () {
    return new Service(fn () =&gt; Container::getInstance());
});
</code></pre>
<h3 id="27db708bcfd0c253b01e08f424d2c62d">请求注入</h3>
<p>请求注入和服务容器类似，因为不同用户请求对象不同，并且可能带有认证状态，所以不能在不同请求之间共享，也就不能作为构造函数参数以单例模式注入服务容器：</p>
<pre><code class="language-php">use App\\Service;

/**
 * Register any application services.
 *
 * @return void
 */
public function register()
{
    $this-&gt;app-&gt;singleton(Service::class, function ($app) {
        return new Service($app['request']);
    });
}</code></pre>
<p>例子中采用 singleton 注册一个单例对象 Service，当该对象在某个 Provider 的 Boot 方法被初始化时，应用容器中将始终保持着唯一的 Service 对象；后续 Worker 在处理的其他请求时，从 Service 中获取的 request 对象将是相同的。</p>
<p>解决思路和服务容器一样，通过普通模式注入或闭包模式注入即可</p>
<pre><code class="language-php">use App\\Service;

$this-&gt;app-&gt;bind(Service::class, function ($app) {
    return new Service($app['request']);
});

$this-&gt;app-&gt;singleton(Service::class, function ($app) {
    return new Service(fn () =&gt; $app['request']);
});

// 或者，还可以直接在服务方法中传入具体请求字段值

$service-&gt;method($request-&gt;input('name'));</code></pre>
<p>对于控制器而言，由于其构造函数也是在服务注册初始化期间完成的，所以不要在其构造函数中注入请求对象，但是可以在具体的控制器方法中注入 Illuminate\Http\Request 实例获取请求信息。</p>
<h3 id="46379fcd70d9617cbbbf26dbdd8d20d6">配置注入</h3>
<p>应用配置也是一个会在运行时发生变更的对象，所以不应该在单例模式服务注入时以构造函数参数形式传入：</p>
<pre><code class="language-php">use App\\Service;

/**
 * Register any application services.
 *
 * @return void
 */
public function register()
{
    $this-&gt;app-&gt;singleton(Service::class, function ($app) {
        return new Service($app-&gt;make('config'));
    });
}</code></pre>
<p>解决方案还是普通模式注入和闭包模式注入：</p>
<pre><code class="language-php">use App\\Service;
use Illuminate\\Container\\Container;

$this-&gt;app-&gt;bind(Service::class, function ($app) {
    return new Service($app-&gt;make('config'));
});

$this-&gt;app-&gt;singleton(Service::class, function () {
    return new Service(fn () =&gt; Container::getInstance()-&gt;make('config'));
});</code></pre>
<h3 id="e1d7a37ee6cda63c47e487a106d93a42">管理内存泄漏</h3>
<p>请记住，Octane在两次请求之间将您的应用程序保留在内存中；因此，将数据添加到静态维护的阵列将导致内存泄漏。例如，由于对应用程&gt;序的每个请求将继续向静态$data数组添加数据，因此以下控制器发生内存泄漏：</p>
<pre><code class="language-php">se App\\Service;
use Illuminate\\Http\\Request;
use Illuminate\\Support\\Str;

/**
 * Handle an incoming request.
 *
 * @param  \\Illuminate\\Http\\Request  $request
 * @return void
 */
public function index(Request $request)
{
    Service::$data[] = Str::random(10);

    // ...
}</code></pre>
<p>关于 Laravel Octane 配置 Swoole 服务的更多使用请参考：<a href="https://laravel.com/docs/8.x/octane#swoole">https://laravel.com/docs/8.x/octane#swoole</a></p>
			</div>
</div>

            <larecipe-back-to-top></larecipe-back-to-top>
        </div>


        <script>
            window.config = [];
        </script>

        <script type="text/javascript">
            if(localStorage.getItem('larecipeSidebar') == null) {
                localStorage.setItem('larecipeSidebar', !! 1);
            }
        </script>

        <script src="../../vendor/binarytorch/larecipe/assets/js/app.js"></script>

        <script>
            window.LaRecipe = new CreateLarecipe(config)
        </script>

        <!-- Google Analytics -->
                <!-- /Google Analytics -->

        
        <script>
            LaRecipe.run()
        </script>
    </body>
</html>
